<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
<meta name="baidu-site-verification" content="5IfwMCE5hH" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.jiezi19971225.cn","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="记录编程学习路上的点滴">
<meta property="og:type" content="website">
<meta property="og:title" content="Jiez19971225‘s Blog">
<meta property="og:url" content="http://www.jiezi19971225.cn/index.html">
<meta property="og:site_name" content="Jiez19971225‘s Blog">
<meta property="og:description" content="记录编程学习路上的点滴">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="jiezi19971225">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://www.jiezi19971225.cn/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Jiez19971225‘s Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Jiez19971225‘s Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">做自己爱做的事</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/10/21/%E6%9D%82%E9%A1%B9/win11%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/21/%E6%9D%82%E9%A1%B9/win11%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">win11升级记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-21 16:45:16" itemprop="dateCreated datePublished" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">折腾记录</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">655(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">2(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>微软在今年宣布推出了 windows 的下一代操作系统 windows 11。说好的 win10 是最后一代 windows 操作系统呢？6 月微软就放出了预览版，不过我没有第一时间升级。依稀记得 win10 是在我高中的时候推出的，我也是第一时间给我的电脑装上了 win10，那个时候我还没怎么接触 linux，甚至觉得 win10 是我见到过的最酷的操作系统了(lll ￢ ω ￢)。不过后来微软在对开发者友好上确实做的不错，推出了新的 windows terminal，官方的包管理器等，docker 等软件也对 win10 有了更好的支持，win10 作为开发环境也挺省心的。</p>
<p>10 月 5 日，微软发布了 win11 的正式版，win10 可以无损免费升级到 win11。于是我花了半天的时间折腾了以下，成功将系统升级为 win11，这里记录一下过程。</p>
<h4 id="win11-升级要求"><a href="#win11-升级要求" class="headerlink" title="win11 升级要求"></a>win11 升级要求</h4><p>忽略硬件要求，主要就这两项</p>
<ul>
<li>开启 tpm2.0</li>
<li>开启安全启动<br>我的平台是 b450m + ryzen r7-2700，硬件上肯定是达标的，这两项技术也支持，可能需要调整的是 bios 的设置</li>
</ul>
<h4 id="升级过程"><a href="#升级过程" class="headerlink" title="升级过程"></a>升级过程</h4><p>首先下载微软官方的 <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/software-download/windows11">win11 升级助手</a></p>
<p>还需要下载 <a target="_blank" rel="noopener" href="https://www.microsoft.com/zh-cn/windows/windows-11#pchealthcheck">windows 健康检查应用</a></p>
<p>运行 windows 健康检查应用，发现不满足 tpm 和 安全启动的条件。<br>进入 bios 发现 tpm 可以开启，安全启动必须关闭 scm support 才出现相应选项</p>
<p>原来我之前的系统还是使用 mbr 方式引导的，而安全启动要求必须以纯 ufei 方式启动，因此我需要将引导方式从 mbr 转变为 gpt。</p>
<p>其实也不麻烦，有现成的工具可用，下载一个傲梅分区助手，对系统盘进行 mbr 转 gpt 的操作，等它帮你慢慢操作就行了，自己玩玩手机，半小时就搞定了，很稳。</p>
<p>之后再进 bios 开启安全启动。这时候进入系统，运行健康检查，发现满足升级条件，此时打开升级助手，就可以开始下载升级文件了。之后就是等待就好了。</p>
<p><img src="/2021/10/21/%E6%9D%82%E9%A1%B9/win11%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95/win11.png" alt="win11"></p>
<p>升级成功！其实感觉就是 win10 换了个皮肤。图标的风格更加扁平与圆润。底部栏与开始菜单移到了中间，肉眼可见的所有东西都加上了圆角。我不懂设计，说不出个所以然来，win11 有啥优点暂时也体验不出来，就当换个皮肤了，先用着吧 O(∩_∩)O。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/10/21/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/yarn%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/21/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/yarn%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">yarn命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-21 16:45:16" itemprop="dateCreated datePublished" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">286(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">1(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="yarn-add"><a href="#yarn-add" class="headerlink" title="yarn add"></a>yarn add</h2><p>-E 选项明确指定版本<br>—audit 检查在已安装的包中所有已经的安全问题并输出</p>
<h2 id="yarn-autoclean"><a href="#yarn-autoclean" class="headerlink" title="yarn autoclean"></a>yarn autoclean</h2><p>autoclean 命令通过从依赖项中删除不必要的文件和文件夹来释放空间。它减少了项目节点模块文件夹中的文件数量，这在直接将包签入版本控制的环境中非常有用。</p>
<h2 id="yarn-bin"><a href="#yarn-bin" class="headerlink" title="yarn bin"></a>yarn bin</h2><p>输出 yarn 安装可执行文件的目录</p>
<h2 id="yarn-cache"><a href="#yarn-cache" class="headerlink" title="yarn cache"></a>yarn cache</h2><p>可以管理下载的包缓存</p>
<h2 id="yarn-create"><a href="#yarn-create" class="headerlink" title="yarn create"></a>yarn create</h2><p>是一个快捷指令</p>
<p>yarn create react-app my-app 就相当于</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn global add create-react-app</span><br><span class="line">create-react-app my-app</span><br></pre></td></tr></table></figure>
<h3 id="peerDependencies"><a href="#peerDependencies" class="headerlink" title="peerDependencies"></a>peerDependencies</h3><p>举个例子，项目中引入了 pakcageA，依赖 A 中的 package.json 中的 dependencies 中包含了 packageB，那么项目的目录结构是这样的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MyProject</span><br><span class="line">|- node_modules</span><br><span class="line">   |- PackageA</span><br><span class="line">      |- node_modules</span><br><span class="line">         |- PackageB</span><br></pre></td></tr></table></figure>
<p>我们在项目中，可以直接通过下面语句引用 PackegeA，但是不能直接引用 PackageB。所以，为了解决这个问题，在 MyProject 项目 package.json 中我们必须直接声明对 PackageB 的依赖并安装。</p>
<p>而如果是在 peerDependencies 声明的 packgeB 的话，得到的目录结构是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MyProject</span><br><span class="line">|- node_modules</span><br><span class="line">   |- PackageA</span><br><span class="line">   |- PackageB</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/10/21/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0/%E5%8E%9F%E7%94%9F%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/21/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E5%AD%A6%E4%B9%A0/%E5%8E%9F%E7%94%9F%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">微信小程序官方文档学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-21 16:45:16" itemprop="dateCreated datePublished" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" itemprop="url" rel="index"><span itemprop="name">微信小程序</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">1.5k(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">5(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="app-json"><a href="#app-json" class="headerlink" title="app.json"></a>app.json</h2><h3 id="window"><a href="#window" class="headerlink" title="window"></a>window</h3><p>backgroundColor 不是背景的颜色 而是下拉页面的背景色</p>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>组件间的生命周期会有些区别</p>
<ul>
<li>onLoad 页面加载，一个页面只会调用一次，可以获得 query 参数</li>
<li>onShow 页面显示 、页面切入前台都会调用</li>
<li>onHide 页面隐藏/切入后台时触发。 如 wx.navigateTo 或底部 tab 切换到其他页面，小程序切入后台等</li>
<li>onReady 页面初次渲染完成，表示可以与视图层进行交互,像动态改变页面标题的就可以在这处理， wx.setNavigationBarTitle</li>
<li>onUnload 页面卸载时触发。如 wx.redirectTo 或 wx.navigateBack 到其他页面时。</li>
</ul>
<p>小程序从启动到关闭，生命周期函数的执行情况<br>1、初次打开： 会执行小程序的生命周期钩子函数：onLaunch -&gt; onShow -&gt; onReady<br>2、使用 navigateTo 离开当前页面： 保留所离开的页面，执行 onHide<br>3、使用 navigateBack 离开当前页面： 销毁当前页面，执行 onHide -&gt; onUnload<br>4、使用 switchTabTo 离开当前页面： 销毁所有非 tab 页面，但保留所有已经加载的 tab 页面</p>
<p>components 中的生命周期函数<br>1、 组件实例化： created 节点树还未导入, 无法使用 setData<br>2、节点树导入完成： attached 可以使用 setData 来初始化数据，但无法操作节点<br>3、组件布局完成: ready 组件布局完成，可以获取到节点信息也可以操作节点<br>4、组件实例被移动到节点树另一个位置： moved<br>5、组件实例从页面节点移除： detached</p>
<h3 id="事件类型"><a href="#事件类型" class="headerlink" title="事件类型"></a>事件类型</h3><p>有冒泡和非冒泡两种</p>
<p>WXML 的冒泡事件列表：<br>类型 触发条件 最低版本<br>touchstart 手指触摸动作开始<br>touchmove 手指触摸后移动<br>touchcancel 手指触摸动作被打断，如来电提醒，弹窗<br>touchend 手指触摸动作结束<br>tap 手指触摸后马上离开<br>longpress 手指触摸后，超过 350ms 再离开，如果指定了事件回调函数并触发了这个事件，tap 事件将不被触发 1.5.0<br>longtap 手指触摸后，超过 350ms 再离开（推荐使用 longpress 事件代替）<br>transitionend 会在 WXSS transition 或 wx.createAnimation 动画结束后触发<br>animationstart 会在一个 WXSS animation 动画开始时触发<br>animationiteration 会在一个 WXSS animation 一次迭代结束时触发<br>animationend 会在一个 WXSS animation 动画完成时触发<br>touchforcechange 在支持 3D Touch 的 iPhone 设备，重按时会触发 1.9.90</p>
<h4 id="bind-和-catch-的区别"><a href="#bind-和-catch-的区别" class="headerlink" title="bind 和 catch 的区别"></a>bind 和 catch 的区别</h4><p>bind 系列事件绑定不会阻止冒泡事件向上冒泡，但是 catch 系列事件绑定可以阻止冒泡事件向上冒泡。</p>
<h3 id="template"><a href="#template" class="headerlink" title="template"></a>template</h3><p>template 可以类比于传统后端模板引擎引用代码片段<br>在一个 wxml 文件中可以定义多个 template，用 name 进行区分</p>
<h4 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h4><h5 id="import"><a href="#import" class="headerlink" title="import"></a>import</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">src</span>=<span class="string">&quot;/templates/item.wxml&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">&quot;item2&quot;</span> <span class="attr">data</span>=<span class="string">&quot;&#123;&#123;text:&#x27;foobar&#x27;&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>import 有作用域的概念，即只会 import 目标文件中定义的 template，而不会 import 目标文件 import 的 template。<br>如：C import B，B import A，在 C 中可以使用 B 定义的 template，在 B 中可以使用 A 定义的 template，但是 C 不能使用 A 定义的 template。</p>
<h5 id="inlcude"><a href="#inlcude" class="headerlink" title="inlcude"></a>inlcude</h5><p>include 可以将目标文件除了 template wxs 外的整个代码引入，相当于是拷贝到 include 位置，如：</p>
<h3 id="响应式数据访问"><a href="#响应式数据访问" class="headerlink" title="响应式数据访问"></a>响应式数据访问</h3><p>在 page 或者 component 中的生命周期或者 methods 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>:&#123;</span><br><span class="line">        <span class="attr">a</span>:<span class="string">&#x27;xxx</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br></pre></td></tr></table></figure>
<h4 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h4><p>需要使用 this.data.a 进行访问，相比与 vue，需要多一层 data 属性，vue 内部对 data 属性的访问是做了代理的，而小程序则没有这层代理</p>
<h4 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h4><p>这种方式很 react</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.setData(&#123;</span><br><span class="line">    <span class="attr">a</span>:<span class="string">&#x27;xxxx&#x27;</span>;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h3><p>required 不支持绝对路径<br>设置 tabbar 坑！ 首页必须包含在其中，否则不能显示<br>npm 安装 weui-wxss 构建 npm 提示 没有找到可以构建的 npm 模块 是因为 weui-wxss 没有导出模块的设置<br>数据库 获取不到数据 这个是数据库访问权限设置的问题</p>
<h3 id="原生-API"><a href="#原生-API" class="headerlink" title="原生 API"></a>原生 API</h3><h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>wx.switchTab 只能跳转到带有 tabbar 的页面 关闭其他所有非 tabBar 页面，跳转路径不能带参数<br>wx.reLaunch 关闭所有页面，打开到应用内的某个页面 路由可以带有参数<br>wx.redirectTo 关闭当前页面，跳转到不带 tabbar 的页面，路由可以带有参数</p>
<p>以上方法可接受一个 Object 作为参数 参数格式如下</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>默认值</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>string</td>
<td>无</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>success</td>
<td>function</td>
<td>无</td>
<td>否</td>
<td>接口调用成功的回调函数</td>
</tr>
<tr>
<td>fail</td>
<td>function</td>
<td>无</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>function</td>
<td>无</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
</div>
<p>wx.navigateBack 关闭当前页面，返回上一页面或者多级页面。可通过 getCurrentPages 获取当前的页面栈，决定需要返回几层。<br>它不接受 url 参数，可以接受一个 delta 作为参数，决定要返回几层</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>默认值</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>delta</td>
<td>number</td>
<td>1</td>
<td>否</td>
<td>返回的页面数，如果 delta 大于现有页面数，则返回到首页。</td>
</tr>
</tbody>
</table>
</div>
<p>wx.navigateTo 保留当前页面，跳转到应用某个页面，但是不能跳转到 tabbar 页面。相比于以上方法，他多了一个可选参数。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>默认值</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>events</td>
<td>Object</td>
<td>无</td>
<td>否</td>
<td>页面间通信接口，用于监听被打开页面发送到当前页面的数据。基础库 2.7.3 开始支持。</td>
</tr>
</tbody>
</table>
</div>
<h4 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h4><p>wx.startPullDownRefresh 可以手动条用 onPllDownRefresh 声明周期的方法<br>wx.pageScrollTo 将页面滚动到目标位置，支持选择器和滚动距离两种方式定位</p>
<h4 id="填坑中"><a href="#填坑中" class="headerlink" title="填坑中"></a>填坑中</h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/07/28/%E6%9D%82%E9%A1%B9/switch%E8%99%9A%E6%8B%9F%E7%B3%BB%E7%BB%9F%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/28/%E6%9D%82%E9%A1%B9/switch%E8%99%9A%E6%8B%9F%E7%B3%BB%E7%BB%9F%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">switch虚拟系统折腾记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-28 20:20:20" itemprop="dateCreated datePublished" datetime="2021-07-28T20:20:20+00:00">2021-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-21 16:45:16" itemprop="dateModified" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">折腾记录</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">1.2k(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">4(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>我的 switch 是我在上大三的时候，也就是 19 年上半年吧，买的可以软破的机器，然后自己折腾的破解。我是一个 JRPG 的爱好者，当时买 switch 的首要原因就是特别想玩它上面独占的八方旅人，其二就是当时还没发售的火纹新作，对塞尔达野吹倒是很无感。不得不说，折腾破解的过程还是很有趣的，去各种资源站，论坛下游戏的过程也很有趣，但是自己却很难再静下心去打通一款游戏了，可能确实是老了。之后很长一段时间，我都认为打游戏这种毫无产出的行为，是在浪费时间，这导致我的 switch 吃灰了很长时间。至今为止，switch 上我还没有打通任何一款游戏。</p>
<p>但是最近又心血来潮，想着把 switch 上的八方旅人打通，再尝试一下勇气默示录 2。大学的时候因为穷，给 switch 只配了 64gb 的内存卡，这让我折腾 switch 一直面临着严重的容量焦虑，有时想安装点新游戏，就必须删掉一些其他游戏，好不自在。<br>我想升级内存卡很久了，之前一直觉得反正也不怎么玩了，就一直没换。但是现在又有玩游戏的想法了，还是要提升一下体验的。<br>我的 switch 破解是大气层单系统破解。现在主流的破解方式都是制作虚拟系统，这个虚拟系统是独立于 switch 本机系统的。可以自由选择启动 switch 本机系统或者虚拟系统，可以在 switch 本机系统中玩正版游戏联网，在虚拟系统中玩学习版的游戏，虚拟系统可以随意折腾，挂掉了重新安装即可，总之优点多多。趁这次机会，我准备把破解方式也升级成虚拟系统的方式。</p>
<p>因此这次折腾要完成以下内容</p>
<ul>
<li>首先买一张内存卡，容量要大大大</li>
<li>将游戏从之前的内存卡迁移到新内存卡</li>
<li>新的内存卡上创建虚拟系统</li>
<li>升级虚拟系统的系统版本</li>
</ul>
<h3 id="动手之前的情况"><a href="#动手之前的情况" class="headerlink" title="动手之前的情况"></a>动手之前的情况</h3><ul>
<li>机器是软破机，大气层版本 0.10.4</li>
<li>switch 系统版本 10.0.3，之前有过几次升级，使用的是大白兔的离线免熔断升级</li>
</ul>
<h3 id="计划实施"><a href="#计划实施" class="headerlink" title="计划实施"></a>计划实施</h3><ul>
<li>首先是内存卡，最后买了闪迪 200G a1，这样除去虚拟系统的 30G，尚有 100 多 G，足够我用了。闲鱼 120 元购得</li>
<li>将原内存卡所有内容到新内存卡，新内存卡插入 swtich，可以正常启动大气层，并且游戏都在</li>
<li>之后看教程进行虚拟系统的创建，这里强力推荐下公众号鹿枫堂游戏分享，无论是破解教程，还是游戏下载，在这个公众号里都能找到</li>
<li>重启 switch 进入 rcm 模式，创建虚拟系统 emummc，等待几分钟创建完毕，然后设置虚拟系统为启用状态</li>
<li>然后升级大气层，用电脑读取内存卡，将大气层相关的文件删除，其中 atomosphere/contents 文件夹和 switch/checkpoint/saves 文件夹需要备份，之后将最新版的大气层文件拷贝到 sd 卡中，大气层升级完成</li>
<li>重启 switch，这时候查看系统版本，发现带有后缀 E，说明当前启动的是虚拟系统</li>
<li>升级 switch 系统，首先在公众号里面下载最新的固件包，将固件包拷贝到内存卡中，启动 switch，进入相册使用 daybreank 进行系统升级</li>
<li>switch 再次重启后，虚拟系统的版本已经更新</li>
</ul>
<h3 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h3><p>上述操作搞定后，进入 switch，发现之前 switch 内存卡中的游戏全部丢失，点击系统找不到数据文件，需要重新安装。还好游戏的 nsp 文件我都还保存着，于是重新安装了一遍，安装完进入游戏，存档还在，可以接受。<br>之后才知道虚拟系统默认在 SD00 文件夹内，该文件夹内有一个 <strong>emummc.ini</strong> 的配置文件，里面可以配置 nintendo 文件夹的路径，而这个文件夹就是游戏文件所在的文件夹</p>
<p>我备份了 atomosphere/contents 文件夹，拷回新内存卡后，大气层启动报错，无奈只好放弃这些备份的还原。这个文件夹主要是一些汉化和金手指，我也不怎么用这些，所以影响不大。感觉可能是因为没有配置 nintendo 文件夹路径，没有找到对应游戏安装位置的原因。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/07/19/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/esbuild%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/19/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/esbuild%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">esbuild简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-19 08:04:20" itemprop="dateCreated datePublished" datetime="2021-07-19T08:04:20+00:00">2021-07-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-21 16:45:16" itemprop="dateModified" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">开发工具</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">3.3k(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">13(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这里说明一下打包工具的概念，打包工具是用来将多个 js 文件和他们的依赖组合成一个或者多个 bundle 文件的工具。前端知名的打包工具有 webpack，rollup，gulp 等。</p>
<p><img src="/2021/07/19/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/esbuild%E7%AE%80%E4%BB%8B/bundle.png" alt="打包过程"></p>
<p>我们的前端项目一般都会使用 webpack 进行构建。随着项目规模不断增加，引入的依赖逐渐增多，我们开启开发服务器和进行生产构建的时间会不断增加。目前我的公司的项目开启开发服务器需要 1 分钟左右，进行生产构建需要 5 分钟以上，而这已经是进行微前端拆分后的结果，如果还是单体巨石应用的结构，那画面太美不敢想象。webpack 的速度实在是太慢，esbuild 就是为了解决这一痛点而被创造出来的。</p>
<p>esbuild 是使用 go 语言编写的一个新一代的 JavaScript 打包工具，它的作者是 figma 的 CTO Evan Wallace。得益于 go 语言编译型语言的优点，打包速度可以达到 webpack 的几十倍。一些知名的热门项目已经内置了 esbuild，比如 vite，snowpack。今天我们就跟随 esbuild 的官方文档，学习一下 esbuild 的相关知识。</p>
<p>下文的主要内容包括</p>
<ul>
<li>为什么 esbuild 这么快</li>
<li>上手使用 esbuild</li>
<li>esbuild plugin api 简介</li>
<li>esbuild 目前的局限</li>
</ul>
<h3 id="esbuild-为什么那么快"><a href="#esbuild-为什么那么快" class="headerlink" title="esbuild 为什么那么快"></a>esbuild 为什么那么快</h3><p>在文档中作者给出了 esbuild 与其他打包工具对 three.js 进行的打包基准测试结果，我们可以看到 esbuild 的速度惊人的快，最高是 rollup 和 webpack 的百倍。<br>| Bundler | Time | Relative slowdown |Absolute speed| Output size|<br>|—-|—-|—-|—-|—-|<br>|esbuild |0.37s |1x |1479.6 kloc/s |5.81mb|<br>|esbuild (1 thread) |1.61s |4x |340.0 kloc/s |5.81mb|<br>|rollup + terser |37.79s |102x |14.5 kloc/s |5.81mb|<br>|parcel 2 |39.28s |106x |13.9 kloc/s |5.87mb|<br>|webpack 4 |43.07s |116x |12.7 kloc/s |5.97mb|<br>|webpack 5 |55.25s |149x |9.9 kloc/s |5.84mb|</p>
<p>这里大家一定非常好奇 esbuild 是如何做到如此之快的，在官方文档的 FAQ 中给出了以下解释:</p>
<h4 id="go-语言编写"><a href="#go-语言编写" class="headerlink" title="go 语言编写"></a>go 语言编写</h4><p>go 是为了<strong>并行</strong>而被设计出来的<strong>编译型语言</strong>，速度相比使用<strong>脚本语言</strong> JavaScript 编写的同类工具有很大的优势。<br>尽管 v8 引擎提供了 JIT 的特性，很大程度上提升了 Javascript 的性能，但是对于命令行程序，它依然太慢了。 每次运行打包器时，JavaScript VM 都会在没有任何优化的情况下运行打包程序的代码。在 esbuild 忙于解析 JavaScript 时，node 还在忙于解析打包程序的 JavaScript。<br>在线程间通信方面， Go 在线程之间可以共享内存，而 JavaScript 必须在线程之间传递序列化数据，这一点显然共享内存的效率更高。<br>Go 和 JavaScript 都有并行的垃圾收集器，但是 Go 的堆在所有线程之间共享，而对于 JavaScript, 每个 JavaScript 线程中都有一个单独的堆。</p>
<h4 id="充分使用并行"><a href="#充分使用并行" class="headerlink" title="充分使用并行"></a>充分使用并行</h4><p>esbuild 内部的算法专门被设计为可以最大程度利用 cpu 资源的形式。esbuild 的工作流程可大致分为三个阶段，解析，链接和代码生成。其中作为主要工作的解析代码和代码生成全部并行方式处理。因为所有的线程共享了内存，不同入口文件的打包工作可以使用相同的导入的 Javascript 模块数据。<br>这里需要额外说明一下，Go 语言是一门为并发编程设计的语言，它原生支持协程。</p>
<h4 id="代码完全自己编写"><a href="#代码完全自己编写" class="headerlink" title="代码完全自己编写"></a>代码完全自己编写</h4><p>esbuild 不使用第三方库，自己来编写实现 js/ts 的编译相关模块，带来了很多细节上的性能优化。</p>
<h4 id="高效使用内存"><a href="#高效使用内存" class="headerlink" title="高效使用内存"></a>高效使用内存</h4><p>理想情况下，编译器以近乎 O(n) 的复杂度处理输入，如果需要处理大量数据，内存访问速度可能会严重影响性能。如果你能更少地遍历代码，编译器的运行速度就会更快。<br>esbuild 只会访问 js/ts 的 AST 三次。<br>第一次是对于词法解析，作用域设置，以及声明符号<br>第二次是绑定符号，压缩语法， JSX/TS 转 JS，ESNext 转 ES2015<br>第三次是压缩标识符，压缩空白字符，生成代码与生成 sourcemap<br>esbuild 最大程度重用了 AST 数据，当它们还在 cpu 的缓存中时。</p>
<p>综合以上的几个方面，使得 esbuild 的速度比起其他打包工具高出一个数量级。</p>
<h3 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h3><p>esbuild 提供了三种方式来使用 esbuild，分别是 命令行，npm 包 和 go 包<br>esbuild 提供了两种调用类型主要 API 类型，Transform API 和 Build API<br>下面分别简单介绍一下它们的使用</p>
<h4 id="npm-包方式"><a href="#npm-包方式" class="headerlink" title="npm 包方式"></a>npm 包方式</h4><p>首先安装 esbuild</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install esbuild</span><br></pre></td></tr></table></figure>
<p>可以看到 esbuild 的 npm 包结构如下:</p>
<p>│ esbuild.exe<br>│ install.js<br>│ package.json<br>│ README.md<br>│<br>├─bin<br>│ esbuild<br>│<br>├─lib<br>│ main.d.ts<br>│ main.js</p>
<p>esbuild 是一个 go 语言编译的可执行程序， 包在安装时会根据所在平台安装对应的可执行程序，windows 系统下就是 esbuild.exe 。lib 下 main.js 提供了对于 esbuild 可执行程序调用的封装。</p>
<p>以下是官网的示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>).writeFileSync(<span class="string">&quot;in.ts&quot;</span>, <span class="string">&quot;let x: number = 1&quot;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;esbuild&quot;</span>).buildSync(&#123;</span><br><span class="line">  <span class="attr">entryPoints</span>: [<span class="string">&quot;in.ts&quot;</span>],</span><br><span class="line">  <span class="attr">outfile</span>: <span class="string">&quot;out.js&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>).readFileSync(<span class="string">&quot;out.js&quot;</span>, <span class="string">&quot;utf8&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="命令行方式"><a href="#命令行方式" class="headerlink" title="命令行方式"></a>命令行方式</h4><p>使用 npm 安装 esbuild 后，我们也可以通过命令行的方式调用 esbuild。esbuild 在 package.json 中定义了 bin 的配置，该文件是一个 node 脚本，用以子进程方式调用 esbuild 可执行文件。</p>
<p>根据 npm 的约定，当 package.json 中定义了 bin 选项时，包安装时会自动将脚本软链接到 node_modules/.bin 目录下。当使用 npm 执行定义在 scripts 中的命令时，会自动将 node_modules/.bin 目录下添加到 PATH 中。通过这种方式就可以以命令行方式调用 esbuild。</p>
<h4 id="Transform-API"><a href="#Transform-API" class="headerlink" title="Transform API"></a>Transform API</h4><p>Transform API 对单个字符串进行操作，它不访问文件系统。这使得它非常适合在没有文件系统(例如浏览器)的环境中使用，或者作为另一个工具链的一部分。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;esbuild&#x27;</span>).transformSync(<span class="string">&#x27;let x: number = 1&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">loader</span>: <span class="string">&#x27;ts&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line">=&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="string">&#x27;let x = 1;\n&#x27;</span>,</span><br><span class="line">  <span class="attr">map</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">warnings</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>社区中有很多基于 esbuild Transform API 打造的其他打包工具的插件，比如</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/privatenumber/esbuild-loader">esbuild-loader</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/egoist/rollup-plugin-esbuild">rollup-plugin-esbuild</a></li>
</ul>
<h4 id="Build-API"><a href="#Build-API" class="headerlink" title="Build API"></a>Build API</h4><p>esbuild 的 Build API 做的事情和 webpack，rollup 等一样，需要入口文件，用于将一系列文件及其以来打包输出到一个或多个文件中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>).writeFileSync(<span class="string">&quot;in.ts&quot;</span>, <span class="string">&quot;let x: number = 1&quot;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;esbuild&quot;</span>).buildSync(&#123;</span><br><span class="line">  <span class="attr">entryPoints</span>: [<span class="string">&quot;in.ts&quot;</span>],</span><br><span class="line">  <span class="attr">outfile</span>: <span class="string">&quot;out.js&quot;</span>,</span><br><span class="line">  <span class="attr">watch</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>).readFileSync(<span class="string">&quot;out.js&quot;</span>, <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">(<span class="string">&quot;let x = 1;\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>设置 watch 选项为 true 既可以开启开发服务器模式，esbuild 会监听文件系统的变化并自动重新 build。</p>
<h3 id="内置-loaders"><a href="#内置-loaders" class="headerlink" title="内置 loaders"></a>内置 loaders</h3><p>esbuild 内置的 loaders 可以处理以下文件类型：JavaScript，typescript，jsx，json，css，text，binary，base64，dataurl，external file</p>
<p>除了 external，其他类型的 loader 会在处理相关扩展名的文件时自动调用，也可以通过 loader 手动设置调用规则。</p>
<p>需要注意的是 esbuild 对于 js 的处理。如果你想要用 esbuild 转译 es5 的代码，需要将<strong>target 设置为 es5</strong>，这可以避免 esbuild 进行错误的转译，比如将<code>&#123;x:x&#125;</code> 转译为 <code>&#123;x&#125;</code>。</p>
<p>esbuild 目前对将<strong>es6+ 的代码转译为 es5 的代码的支持不完善</strong>，如 <code>let</code>，<code>const</code> 等语法不会被转译。</p>
<h3 id="插件机制"><a href="#插件机制" class="headerlink" title="插件机制"></a>插件机制</h3><p>同 rollup 和 和 webpack 一样，esbuild 提供了插件机制，目前 esbuild 的插件 api 还在实验阶段，在未来可能会有很大的变动。<br><strong>esbuild 目前只支持在 build API 中使用插件，不支持 transform API</strong>。</p>
<h4 id="编写-esbuild-插件"><a href="#编写-esbuild-插件" class="headerlink" title="编写 esbuild 插件"></a>编写 esbuild 插件</h4><p>一个 esbuild 的插件是一个对象，有一个 <code>name</code> 属性和一个 <code>setup</code> 函数。在 build API 中，我们可以设置 plugins 数组。插件对象中的 <code>setup</code> 函数会在 build 每次运行时调用一次。</p>
<p>下面是文档中的例子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> envPlugin = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;env&quot;</span>,</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params">build</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// Intercept import paths called &quot;env&quot; so esbuild doesn&#x27;t attempt</span></span><br><span class="line">    <span class="comment">// to map them to a file system location. Tag them with the &quot;env-ns&quot;</span></span><br><span class="line">    <span class="comment">// namespace to reserve them for this plugin.</span></span><br><span class="line">    build.onResolve(&#123; <span class="attr">filter</span>: <span class="regexp">/^env$/</span> &#125;, <span class="function">(<span class="params">args</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">path</span>: args.path,</span><br><span class="line">      <span class="attr">namespace</span>: <span class="string">&quot;env-ns&quot;</span>,</span><br><span class="line">    &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load paths tagged with the &quot;env-ns&quot; namespace and behave as if</span></span><br><span class="line">    <span class="comment">// they point to a JSON file containing the environment variables.</span></span><br><span class="line">    build.onLoad(&#123; <span class="attr">filter</span>: <span class="regexp">/.*/</span>, namespace: <span class="string">&quot;env-ns&quot;</span> &#125;, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">contents</span>: <span class="built_in">JSON</span>.stringify(process.env),</span><br><span class="line">      <span class="attr">loader</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;esbuild&quot;</span>)</span><br><span class="line">  .build(&#123;</span><br><span class="line">    <span class="attr">entryPoints</span>: [<span class="string">&quot;app.js&quot;</span>],</span><br><span class="line">    <span class="attr">bundle</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outfile</span>: <span class="string">&quot;out.js&quot;</span>,</span><br><span class="line">    <span class="attr">plugins</span>: [envPlugin],</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function">() =&gt;</span> process.exit(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p>这个插件的作用是让 esbuild 将以 env 结尾的文件作为 json 文件解析。可以看到 esbuild 的插件编写非常简单，只有少量的关键概念和关键 API，下面我们来简单了解一下。</p>
<h4 id="两个关键观念"><a href="#两个关键观念" class="headerlink" title="两个关键观念"></a>两个关键观念</h4><h5 id="Namespaces-命名空间"><a href="#Namespaces-命名空间" class="headerlink" title="Namespaces 命名空间"></a>Namespaces 命名空间</h5><p>每个模块有一个关联的命名空间。默认情况下，esbuild 在 <code>file</code> 命名空间下工作，它对应于真实文件系统上的文件。<br>esbuild 也可以处理虚拟的模块，即并不对应于文件系统上的文件。举个例子，比如从 <code>stdin</code> 中提供的模块。</p>
<p>可以用插件去创建虚拟模块，标注模块在一个特定的命名空间，以使用其他的插件进行特殊处理。</p>
<h5 id="Filters-过滤器"><a href="#Filters-过滤器" class="headerlink" title="Filters 过滤器"></a>Filters 过滤器</h5><p>每一个回调函数必须提供一个正则表达式作为过滤器，那些不匹配的模块将被跳过处理。<br>你应该尽可能使用过滤正则表达式而非使用 js 代码来处理，因为 Filters 是在 esbuild 内部处理的，效率更高。</p>
<h4 id="两个主要回调"><a href="#两个主要回调" class="headerlink" title="两个主要回调"></a>两个主要回调</h4><h5 id="onResolve-回调"><a href="#onResolve-回调" class="headerlink" title="onResolve 回调"></a>onResolve 回调</h5><p>使用 onResolve 添加的回调会在每次 esbuild build 过程中的路径解析阶段被调用。这个回调用来自定义 esbuild 解析路径的行为。</p>
<p>下面这个例子中，插件将以 images 开头的导入路径重定向到 /public/images 目录，将 http 开头的路径标记为 external。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> exampleOnResolvePlugin = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;example&quot;</span>,</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params">build</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redirect all paths starting with &quot;images/&quot; to &quot;./public/images/&quot;</span></span><br><span class="line">    build.onResolve(&#123; <span class="attr">filter</span>: <span class="regexp">/^images\//</span> &#125;, <span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">path</span>: path.join(args.resolveDir, <span class="string">&quot;public&quot;</span>, args.path) &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mark all paths starting with &quot;http://&quot; or &quot;https://&quot; as external</span></span><br><span class="line">    build.onResolve(&#123; <span class="attr">filter</span>: <span class="regexp">/^https?:\/\//</span> &#125;, <span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">path</span>: args.path, <span class="attr">external</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="onLoad-回调"><a href="#onLoad-回调" class="headerlink" title="onLoad 回调"></a>onLoad 回调</h5><p>使用 onLoad 添加的回调会在所有没有被标记为 external 的模块中运行，模块由路径和命名空间共同标识。它用来自定义模块返回的内容，告诉 esbuild 如何去转译它。</p>
<p>下面这个例子中，插件将以 txt 文件以 utf8 方式获取内容后，以 json 数据形式读取。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> exampleOnLoadPlugin = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;example&quot;</span>,</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params">build</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load &quot;.txt&quot; files and return an array of words</span></span><br><span class="line">    build.onLoad(&#123; <span class="attr">filter</span>: <span class="regexp">/\.txt$/</span> &#125;, <span class="keyword">async</span> (args) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> text = <span class="keyword">await</span> fs.promises.readFile(args.path, <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">contents</span>: <span class="built_in">JSON</span>.stringify(text.split(<span class="regexp">/\s+/</span>)),</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;esbuild&quot;</span>)</span><br><span class="line">  .build(&#123;</span><br><span class="line">    <span class="attr">entryPoints</span>: [<span class="string">&quot;app.js&quot;</span>],</span><br><span class="line">    <span class="attr">bundle</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">outfile</span>: <span class="string">&quot;out.js&quot;</span>,</span><br><span class="line">    <span class="attr">plugins</span>: [exampleOnLoadPlugin],</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function">() =&gt;</span> process.exit(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<h4 id="esbuild-插件的局限"><a href="#esbuild-插件的局限" class="headerlink" title="esbuild 插件的局限"></a>esbuild 插件的局限</h4><p>esbuild 的插件无法做到覆盖全部的用户场景。它只提供了自定义模块家在方式和自定义模块返回内容的能力，没有提供给我们直接访问 js ast 的能力，这是出于为了保持 esbuild 卓越性能的考虑，但这也导致很多 babel 插件提供的基于 js ast 的转译功能都无法使用 esbuild 的插件机制来实现。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>esbuild 作为打包工具的性能表现是极为出色的，但是现阶段并不能代替 webpack。一方面，webpack 经过多年的发展，生态非常成熟，可以覆盖到几乎所有的使用场景，另一方面，esbuild 本身受限的插件机制使得它注定无法完成一些事情。<br>比如说我们使用 webpack 中使用的 基于 ast 的 babel 插件，是没办法迁移到 esbuild 中去的，因为 esbuild 根本不提供访问 ast 的能力。<br>对于基于 webpack 的老项目，通常包含了很多基于 webpack 生态的 loader，插件等，将它们迁移到 esbuild 是一项艰巨且风险巨大的工作。新的项目没有技术债务，可以使用 esbuild 作为构建工具，可以极大提升开发体验。<br>但是，把 esbuild 作为纯的 js/ts 转译工具，或者作为代码压缩工具，作为其他构建工具工具链的一部分，是可以的融入到老项目中，提升构建速度的。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://esbuild.github.io/">esbuild 官方文档</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39843414/article/details/117719170">「 不懂就问 」esbuild 为什么这么快?</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/02/21/%E6%9D%82%E9%A1%B9/%E6%97%B6%E5%8C%BA%E9%97%AE%E9%A2%98%E8%B8%A9%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/21/%E6%9D%82%E9%A1%B9/%E6%97%B6%E5%8C%BA%E9%97%AE%E9%A2%98%E8%B8%A9%E5%9D%91/" class="post-title-link" itemprop="url">时区问题踩坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-21 14:51:42" itemprop="dateCreated datePublished" datetime="2021-02-21T14:51:42+00:00">2021-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-21 16:45:16" itemprop="dateModified" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9D%82%E9%A1%B9/" itemprop="url" rel="index"><span itemprop="name">杂项</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">311(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">1(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天被时区的问题困扰了好久，踩了不少坑，在此记录一下。</p>
<h3 id="go-中的时区"><a href="#go-中的时区" class="headerlink" title="go 中的时区"></a>go 中的时区</h3><p>go 中 time.Now() 取的是系统的时区。</p>
<p>time.parse 默认采用的是 UTC 时间进行解析，UTC 时即世界协调时间。</p>
<p>我们中国使用的北京时间是东八区时间，领先了 UTC 八个小时。</p>
<p>举个例子，现在是北京时间 2021/2/21 15:00:00，用 time.parse 解析得到的时间 2021/2/21 15:00:00 +0:00，而这个解析到的时间对应到北京时间是 2021/2/21 23:00:00 +8:00</p>
<p>time.Now() 取到的系统时间是 2021/2/21 15:00:00 +8:00，这种情况下做时间的比较，是无法得到正确的结果的，同时如果使用 gorm 等事件保存到数据库中，保存的时间也是比正确的时间晚了 8 小时的。</p>
<p>所以应当使用 time.parseInLocation</p>
<h3 id="容器中的时区"><a href="#容器中的时区" class="headerlink" title="容器中的时区"></a>容器中的时区</h3><p>使用 docker-compose，可以设置 environment 中的 TZ 设置时区，前提是镜像中安装了 tzdata 这个软件。如果没有，设置时无法生效的。</p>
<h3 id="mysql-中的时区"><a href="#mysql-中的时区" class="headerlink" title="mysql 中的时区"></a>mysql 中的时区</h3><p>默认会采用系统时区，可以在 my.cnf 中手动设置默认的时区。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/" class="post-title-link" itemprop="url">深圳游记-深圳湾公园与世界之窗</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-18 00:01:45" itemprop="dateCreated datePublished" datetime="2021-02-18T00:01:45+00:00">2021-02-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-21 16:45:16" itemprop="dateModified" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B8%B8%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">游记</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">2.8k(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">9(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>大学开始，慢慢养成了记录技术类博客的习惯，当然这也是比较实用主义的做法，因为接触的知识真的很多，如果不记录下来，过一段时间就是忘光光了，这也就是知识管理的重要性。</p>
<p>但是生活其实也并不只是工作学习，并且随着年龄的增长，我越来越感觉到时间的珍贵，对于逝去的时间，如果不记录些什么，就感觉白白浪费了。所以也想要尝试记录生活，留住感动，去抓住逝去的时光。今后的话，大概会写一些出去玩的游记和游戏记录相关的内容吧。另外本人的文笔不好，希望也可以慢慢练习吧。</p>
<h3 id="出发"><a href="#出发" class="headerlink" title="出发"></a>出发</h3><p>作为一个平日深居简出的宅宅，其实出去玩对我是没有什么吸引力的。之前在杭州实习，呆了几个月，甚至都没有去西湖走一遭，现在感觉还是挺遗憾的。说实话，这次出去很大一个原因是怕万一别人问起我春节不回家去了哪里玩，如果说一直霉在出租屋里，总感觉不太好。本来计划着初三出去的，显然我丝毫没有意识到初三是情人节的事实，这出去还不被虐成狗啊。初三是出去不成了，初四又是慵懒的一天，就这样拖到了初五，下定决心一定要出去了，在网上搜深圳有哪些好玩的地方，然后想起之前同事跟我提过可以去深圳湾公园，地铁直达的样子，搜了一下，感觉靠谱，出发！</p>
<h3 id="深圳湾公园"><a href="#深圳湾公园" class="headerlink" title="深圳湾公园"></a>深圳湾公园</h3><p>从塘朗地铁站出发，经过两次转线，大约历时一个小时，到达 9 号线深圳湾公园站。深圳湾这块绝对是个游玩的胜地，光是地铁站的出口有好几个，分别去往不同的地方。去往深圳湾公园的出口沿着扶梯上去，就来到了公园的门口。意外的是人是挺多的，远远望去都是人，除了必须要带上口罩外，完全看不到疫情带来的影响。</p>
<p>来了公园这边，想做的事情当然就是看海了。想到跟大海零距离接触，虽然说不上激动，但是对于我这个在内陆地区长大的人来说，这种感觉还是挺奇妙的。</p>
<p>之前跟同事聚餐完后一个人跑到人才公园那边感受了一下，看到的是深圳这座大都市海滨的华灯璀璨，让我不禁感慨这才是深圳该有的样子。</p>
<p>在 B 站视频里见过的深圳湾地标-春笋。</p>
<p><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/春笋.jpg" alt="春笋"></p>
<p>夜景</p>
<p><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/深圳湾夜景.jpg" alt="深圳湾夜景"></p>
<p>但是在深圳湾公园这边，感受到的则是一种宁静。看着大海的浪潮起伏，感受着湿润的海风朝自己扑来，最惊喜的是可以“文明观鸟”。</p>
<p><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/文明观鸟.jpg" alt="文明观鸟"></p>
<p>在最靠近这群海鸟的地方，有几个人用装着半米长镜头的相机在拍摄，真是专业的不行，海岸边有公园的工作人员举着宣传语，让人们“文明观鸟”，不要擅自给海鸟喂食，人们无知善意的举动，实际上是可能伤害它们的。</p>
<p>公园绵延海岸线十几公里，我从入口一路往东走，就到了红树林，这边的海岸是生长着红树林的湿地，这边的滩涂上，有那种一跳一跳的鱼，不时会有几只一跃而起，很是神奇。</p>
<p>就这样沿着海岸线走着走着，想到既然来了，晚上去再去别的地方玩玩好了。本来是想要去民俗村的，但是订票的时候显示票已售罄的。看到世界之窗也在附近，看评价似乎挺好，于是就定了夜场的票。订票的时候已经是 5 点了，6 点是夜场入门的时间，在公园又溜了一会后，我决定步行前往。但是这里我犯了一个错误，我没有用地图的导航功能，我从公园的出口出来了，想要过马路到对面，但是实际上这里必须走地铁的地下通道才能过去，绕了一大圈，花了不少时间，还是骑单车在 6 点半的时候赶到了入口。</p>
<h3 id="世界之窗"><a href="#世界之窗" class="headerlink" title="世界之窗"></a>世界之窗</h3><p>公园的入口处，是巴黎卢浮宫的微型仿制建筑，上面有江泽民主席的题字，看到这个，真的忍不住要膜一下。</p>
<p><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/世界之窗.jpg" alt="世界之窗"></p>
<p>深圳是中国向世界开放的窗口，世界之窗这个主题公园里，浓缩了世界著名的景观，也是中国人认识世界的一个窗口。</p>
<p>入园后，我突然意识到了一个问题，几乎所有的游客，要么就是家长带小孩，要么就是情侣一起，最次也是几个好哥们同行，似乎只有我是一个人来玩的。不过好在我内心还是很强大的，即使是一个人，来感受下氛围也好，毕竟钱都已经花了。当然有了这次的前车之鉴，下次我是绝对不会再一个人来这种主题公园了。。。</p>
<p>公园的正中心是缩小版的埃菲尔铁塔，然后分为东西两边两大块区域。</p>
<h4 id="东区"><a href="#东区" class="headerlink" title="东区"></a>东区</h4><p>我一开始去了东边。地图标注一些的景观，实际上都只是这种微缩的模型，比如下面的天皇居所，还有泰姬陵，一开始让我感觉略微有点失望，就这？</p>
<p><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/天皇の住居.jpg" alt="天皇の住居"></p>
<p>然后，再走不远就到了日本主题的地区。这里有租借和服的，我看到有小姐姐租借了穿的，是真的好漂亮，我要是女生也真的好想穿上试试。</p>
<p>日本馆的和风是很有味道的<br><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/日本馆.jpg" alt="日本馆"></p>
<p>这个富士山就挺让人一言难尽的<br><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/富士山.jpg" alt="富士山"></p>
<p>逛完了这里，天色已经暗了下来了，这些景观的观看效果大大打了折扣。东区的话，还有东南亚，欧洲和大洋洲的景观。下面是科隆大教堂，历史上这座教堂断断续续修了几百年，是天主教最著名的几座教堂之一，即使只看模型，也还是能被他的宏伟震撼。只是这里的灯光，把它变得有点魔幻。。。</p>
<p><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/科隆大教堂.jpg" alt="科隆大教堂"></p>
<p>凯旋门，拿皇万岁！<br><img src="/2021/02/18/%E6%B8%B8%E8%AE%B0/%E6%B7%B1%E5%9C%B3%E6%B8%B8%E8%AE%B0-%E6%B7%B1%E5%9C%B3%E6%B9%BE%E5%85%AC%E5%9B%AD%E4%B8%8E%E4%B8%96%E7%95%8C%E4%B9%8B%E7%AA%97/凯旋门.jpg" alt="凯旋门"></p>
<p>差不多逛完了东区，已经快要 7 点了，这时我才知道，景区的一些免费项目是有开放时间限制的。之前在网上了解的像飞跃美利坚之类的必玩项目，7 点就结束了，后悔自己没有多做点功课了。</p>
<p>这个时候，人都在往中心的埃菲尔铁塔赶了。这里 7 点 15 会有灯光秀的表演，在表演开始之前，这里有几个演员穿着奇异的装束在这里打鼓，我是真的不知道他们打扮的是啥东西，只是想感叹钱难挣啊，这么打扮我感觉是挺难受的。</p>
<p>灯光秀准时开始，配合这恢弘的 BGM，效果还是很震撼的，但是时间嘛比较短，大概 5 分钟就结束了，让人有点意犹未尽。</p>
<h4 id="演出盛世纪"><a href="#演出盛世纪" class="headerlink" title="演出盛世纪"></a>演出盛世纪</h4><p>7 点 30 在中心的广场有歌舞剧演出，我到的时候，外场中间的位置已经坐满了（内场是额外花钱的）。我只能在边界找了个位置坐下，角度可以说非常差了。</p>
<p>歌舞剧把中国上下五千年的文化浓缩到了一台歌舞剧中，从后羿射日，到春秋战国，再到大汉王朝，再到大唐盛世。大秦的部分确实把秦军的气势展现了出来，大汉王朝则是把汉的儒学文化和张骞通西域的开放包容展现了出来，大唐的部分更是分成了四幕，从盛世长安到雪域高原。<br>刚开始看的确实挺震撼的，但是看多了，要么是一群男的舞刀弄枪，要么是一群女的在哪里跳舞，要么是几个外国人上来耍耍鞭子流星锤啥的，就有点审美疲劳了。渐渐的外场的人走的越来越多，内场的人倒是没见有走的，毕竟是花钱了的 😄。我是看到了郑和下西洋那一幕，觉的没啥意思了，就溜了。</p>
<h4 id="外籍演员演出"><a href="#外籍演员演出" class="headerlink" title="外籍演员演出"></a>外籍演员演出</h4><p>这之后我本来是打算赶快把西区逛一逛的，刚向西没过多久，就看到路上的人都在往中间赶，原来是有烟花的演出。现在春节都是禁止燃放烟花了，能看到烟花演出，确实不容易的，我也就跟着也往中间跑去了，可等待感到了中间，烟花都已经放完了，算了，就是感受个氛围吧。</p>
<p>到了中间，听到广播在说 9 点 15 凯撒宫那边会有梦幻欧洲灯光表演，人群都在往凯撒宫那边去，我也就跟着过去了。我跟着人群进到了宫殿内部，这里其实是一个剧场，我刚开始挺怀疑的，这里也能有灯光表演吗？等到了 9 点 15，表演也没有开始，然后挺广播才知道，这里面要开始的是一个外籍演员的专场演出，灯光表演是在外面。不过既然在里面坐下了，我也就等到它的演出开始了。</p>
<p>整场演出十分精彩，印象最深的是里面肯尼亚黑人表演的杂技，看了除了牛逼想不出别的词语来形容了。这些黑人演员的力气和胆子是真的大，各种杂技动作难度非常之高。最吸引研究的就是里面的毛妹了，有大毛也有二毛，有一说一，确实都是大美人，身材也都是顶级的。感觉整场演出里俄罗斯的人最多，为什么他们要跑来深圳打工呢，因为俄罗斯经济不景气吗？最后是小丑的滑稽剧表演，小时候看央视的正大综艺看过这种表演，在现场看这种演示还是生平第一次，最后也是在一片欢乐祥和中结束了整场演出。</p>
<h4 id="遗憾"><a href="#遗憾" class="headerlink" title="遗憾"></a>遗憾</h4><p>看完演出已经 10 点了，显然已经没有时间再去西区了，想想是挺遗憾的。不过生活嘛，本来就是充满遗憾的，这次来本来就挺仓促的，一个人的话，甚至不能好好拍点照片留念，不过我是觉得已经体验到挺多了，以后如果有机会，再和朋友好好玩一次吧。</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>我是在开工前的夜晚赶出来的这篇游记。我在这段时间一直被焦虑的情绪困扰，这次出来玩了一趟过后，确实轻松了不少。长假已经过去，是时候收拾好心情，迎接年后的新的工作挑战了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/02/15/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAjsonParser/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/15/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAjsonParser/" class="post-title-link" itemprop="url">实现一个jsonParser</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-15 15:39:25" itemprop="dateCreated datePublished" datetime="2021-02-15T15:39:25+00:00">2021-02-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-21 16:45:16" itemprop="dateModified" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">编译原理</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">3.3k(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">18(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>想要学习编译原理这门课已经很久了，自己之前也有尝试看龙书或者听公开课，可是这样学到的公式性的知识太多，每次都没有坚持学习下去。</p>
<p>放假这几天学习了极客时间上的《编译原理之美 》这门专栏，把讲编译器前端部分的看完了。这个老师讲的是真的好，比较浅显的语言来讲解教科书上用大段公式说明的知识，同时结合了大量的实践内容，帮助我快速了解了编译原理的核心要点的同时，同时教授了我动手的能力。</p>
<p>之前面试 bilibili 的时候，面试官就问过我如何用代码实现验证一个 json 的有效性，当时回答很糟糕，完全没有使用编译技术这方面的意识。</p>
<p>其实编译技术就很好处理这种问题，走一边词法分析和语法分析的流程，在解析 token 或者 构建 ast 的过程中如果出错了，那么这个 json 就是非法的了。</p>
<p>既是为了练手，也是填上之前面试的这个坑，下面就简单实现一个 jsonParser。</p>
<h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>写一个 jsonParse 其实很简单，但是自己还是花了不少时间来做这件事，也走了一些弯路，还抄了不少参考资料才写好的 😓。</p>
<p>资料列表：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.json.org/json-en.html">https://www.json.org/json-en.html</a> json 官网，里面有介绍 json 的语法规则</li>
<li><a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode/blob/master/src/vs/base/common/json.ts">https://github.com/microsoft/vscode/blob/master/src/vs/base/common/json.ts</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/richard-gong/PlayWithCompiler/blob/master/lab/craft/SimpleLexer.java">专栏中的 SimpleLexer</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/richard-gong/PlayWithCompiler/blob/master/lab/craft/SimpleParser.java">专栏中的 SimpleParser</a></li>
</ul>
<p>首先要解析 json，我们必须要了解 json 的语法规则。接触了 json 这么久，我还是第一次看 json 的语法规则定义，有不少新发现的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">json</span><br><span class="line">  element</span><br><span class="line"></span><br><span class="line">value</span><br><span class="line">  object</span><br><span class="line">  array</span><br><span class="line">  string</span><br><span class="line">  number</span><br><span class="line">  &quot;true&quot;</span><br><span class="line">  &quot;false&quot;</span><br><span class="line">  &quot;null&quot;</span><br><span class="line"></span><br><span class="line">object</span><br><span class="line">  &#x27;&#123;&#x27; ws &#x27;&#125;&#x27;</span><br><span class="line">  &#x27;&#123;&#x27; members &#x27;&#125;&#x27;</span><br><span class="line"></span><br><span class="line">members</span><br><span class="line">  member</span><br><span class="line">  member &#x27;,&#x27; members</span><br><span class="line"></span><br><span class="line">member</span><br><span class="line">  ws string ws &#x27;:&#x27; element</span><br><span class="line"></span><br><span class="line">array</span><br><span class="line">  &#x27;[&#x27; ws &#x27;]&#x27;</span><br><span class="line">  &#x27;[&#x27; elements &#x27;]&#x27;</span><br><span class="line"></span><br><span class="line">elements</span><br><span class="line">  element</span><br><span class="line">  element &#x27;,&#x27; elements</span><br><span class="line"></span><br><span class="line">element</span><br><span class="line">  ws value ws</span><br><span class="line"></span><br><span class="line">string</span><br><span class="line">  &#x27;&quot;&#x27; characters &#x27;&quot;&#x27;</span><br><span class="line"></span><br><span class="line">characters</span><br><span class="line">  &quot;&quot;</span><br><span class="line">  character characters</span><br><span class="line"></span><br><span class="line">character</span><br><span class="line">  &#x27;0020&#x27; . &#x27;10FFFF&#x27; - &#x27;&quot;&#x27; - &#x27;\&#x27;</span><br><span class="line">  &#x27;\&#x27; escape</span><br><span class="line"></span><br><span class="line">escape</span><br><span class="line">  &#x27;&quot;&#x27;</span><br><span class="line">  &#x27;\&#x27;</span><br><span class="line">  &#x27;/&#x27;</span><br><span class="line">  &#x27;b&#x27;</span><br><span class="line">  &#x27;f&#x27;</span><br><span class="line">  &#x27;n&#x27;</span><br><span class="line">  &#x27;r&#x27;</span><br><span class="line">  &#x27;t&#x27;</span><br><span class="line">  &#x27;u&#x27; hex hex hex hex</span><br><span class="line"></span><br><span class="line">hex</span><br><span class="line">  digit</span><br><span class="line">  &#x27;A&#x27; . &#x27;F&#x27;</span><br><span class="line">  &#x27;a&#x27; . &#x27;f&#x27;</span><br><span class="line"></span><br><span class="line">number</span><br><span class="line">  integer fraction exponent</span><br><span class="line"></span><br><span class="line">integer</span><br><span class="line">  digit</span><br><span class="line">  onenine digits</span><br><span class="line">  &#x27;-&#x27; digit</span><br><span class="line">  &#x27;-&#x27; onenine digits</span><br><span class="line"></span><br><span class="line">digits</span><br><span class="line">  digit</span><br><span class="line">  digit digits</span><br><span class="line"></span><br><span class="line">digit</span><br><span class="line">  &#x27;0&#x27;</span><br><span class="line">  onenine</span><br><span class="line"></span><br><span class="line">onenine</span><br><span class="line">  &#x27;1&#x27; . &#x27;9&#x27;</span><br><span class="line"></span><br><span class="line">fraction</span><br><span class="line">  &quot;&quot;</span><br><span class="line">  &#x27;.&#x27; digits</span><br><span class="line"></span><br><span class="line">exponent</span><br><span class="line">  &quot;&quot;</span><br><span class="line">  &#x27;E&#x27; sign digits</span><br><span class="line">  &#x27;e&#x27; sign digits</span><br><span class="line"></span><br><span class="line">sign</span><br><span class="line">  &quot;&quot;</span><br><span class="line">  &#x27;+&#x27;</span><br><span class="line">  &#x27;-&#x27;</span><br><span class="line"></span><br><span class="line">ws</span><br><span class="line">  &quot;&quot;</span><br><span class="line">  &#x27;0020&#x27; ws</span><br><span class="line">  &#x27;000A&#x27; ws</span><br><span class="line">  &#x27;000D&#x27; ws</span><br><span class="line">  &#x27;0009&#x27; ws</span><br></pre></td></tr></table></figure>
<p>通过看规范，我们知道 json 支持 <code>\u0020-\uffff</code> unicode 的，支持部分转义字符，支持数字的科学计数法表示，这些在我们写 parser 时都是要考虑进去的。</p>
<p>规则定义属性名是 string，也就是可以是空串，或者包含转义字符。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;\\n&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的 json 是合法的，至少我之前是想不到的。</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>lexer 的写法参考了专栏的示例，用了 DFA 的方式，状态转移图直接参考 json 官网的弹珠图就好了。</p>
<p>举个典型的，数字的状态转移。</p>
<p><img src="/2021/02/15/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAjsonParser/number.png" alt="number的弹珠图"></p>
<p>我们定义如下状态</p>
<p>NumberMinus,<br>NumberZeroStart,<br>NumberNormal,<br>NumberDot,<br>NumberAfterDot,<br>NumberE,<br>NumberESign,<br>NumberAfterE,</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DFAState.NumberMinus:</span><br><span class="line">  <span class="keyword">if</span> (ch === CharacterCodes._0) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberZeroStart;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberNormal;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidNumber);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DFAState.NumberZeroStart:</span><br><span class="line">  <span class="keyword">if</span> (ch === CharacterCodes.dot) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberAfterDot;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.initState(ch);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DFAState.NumberNormal:</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.dot) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberDot;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.e || ch === CharacterCodes.E) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberE;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.initState(ch);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DFAState.NumberDot:</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberAfterDot;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidNumber);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DFAState.NumberE:</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberAfterE;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    ch === CharacterCodes.plus ||</span><br><span class="line">    ch === CharacterCodes.minus</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberESign;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidNumber);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DFAState.NumberESign:</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberAfterE;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidNumber);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DFAState.NumberAfterDot:</span><br><span class="line">  <span class="keyword">if</span> (ch === CharacterCodes.e || ch === CharacterCodes.E) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberE;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.initState(ch);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> DFAState.NumberAfterE:</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.initState(ch);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">initState</span>(<span class="params">ch: any</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 省略。。。。</span></span><br><span class="line">  <span class="built_in">this</span>.token = <span class="keyword">new</span> Token();</span><br><span class="line">  <span class="keyword">if</span> (ch === CharacterCodes.minus) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberMinus;</span><br><span class="line">    <span class="built_in">this</span>.token.type = TokenType.NumberType;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes._0) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberZeroStart;</span><br><span class="line">    <span class="built_in">this</span>.token.type = TokenType.NumberType;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = DFAState.NumberNormal;</span><br><span class="line">    <span class="built_in">this</span>.token.type = TokenType.NumberType;</span><br><span class="line">    <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">  &#125; <span class="comment">// 省略。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只是将图中状态的转移用代码的形式表现出来，做这类工作的时候，分析的过程比编码要重要的多。</p>
<p>parser 也很简单，用递归下降的方式很容易实现。</p>
<p>完整代码如下，只是实现了基本的功能，没做什么错误处理</p>
<h4 id="lexer"><a href="#lexer" class="headerlink" title="lexer"></a>lexer</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CharacterCodes &#125; <span class="keyword">from</span> <span class="string">&quot;./CharacterCodes&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Token, TokenType &#125; <span class="keyword">from</span> <span class="string">&quot;./token&quot;</span>;</span><br><span class="line"></span><br><span class="line">enum DFAState &#123;</span><br><span class="line">  Initial,</span><br><span class="line">  OpenBracket,</span><br><span class="line">  CloseBracket,</span><br><span class="line">  OpenBraces,</span><br><span class="line">  CloseBraces,</span><br><span class="line">  Colon,</span><br><span class="line">  Comma,</span><br><span class="line">  NumberMinus,</span><br><span class="line">  NumberZeroStart,</span><br><span class="line">  NumberNormal,</span><br><span class="line">  NumberDot,</span><br><span class="line">  NumberAfterDot,</span><br><span class="line">  NumberE,</span><br><span class="line">  NumberESign,</span><br><span class="line">  NumberAfterE,</span><br><span class="line">  StringNormal,</span><br><span class="line">  StringSlash,</span><br><span class="line">  StringSlashU,</span><br><span class="line">  StringInHex,</span><br><span class="line">  StringEnd,</span><br><span class="line">  NullType,</span><br><span class="line">  TrueType,</span><br><span class="line">  FalseType,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> nullSteps = [<span class="string">&quot;n&quot;</span>, <span class="string">&quot;nu&quot;</span>, <span class="string">&quot;nul&quot;</span>, <span class="string">&quot;null&quot;</span>];</span><br><span class="line"><span class="keyword">const</span> trueSteps = [<span class="string">&quot;t&quot;</span>, <span class="string">&quot;tr&quot;</span>, <span class="string">&quot;tru&quot;</span>, <span class="string">&quot;true&quot;</span>];</span><br><span class="line"><span class="keyword">const</span> falseSteps = [<span class="string">&quot;f&quot;</span>, <span class="string">&quot;fa&quot;</span>, <span class="string">&quot;fal&quot;</span>, <span class="string">&quot;fals&quot;</span>, <span class="string">&quot;false&quot;</span>];</span><br><span class="line"></span><br><span class="line">enum LexErrorType &#123;</span><br><span class="line">  EOF,</span><br><span class="line">  InvalidKeyword,</span><br><span class="line">  InvalidNumber,</span><br><span class="line">  InvalidStringCharacter,</span><br><span class="line">  UnexeceptedCharacter,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wschar = [</span><br><span class="line">  CharacterCodes.space,</span><br><span class="line">  CharacterCodes.lineFeed,</span><br><span class="line">  CharacterCodes.tab,</span><br><span class="line">  CharacterCodes.formFeed,</span><br><span class="line">  CharacterCodes.backspace,</span><br><span class="line">  CharacterCodes.carriageReturn,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorObject</span> </span>&#123;</span><br><span class="line">  type!: LexErrorType;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">type: LexErrorType</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.type = type;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Lexer</span> </span>&#123;</span><br><span class="line">  <span class="attr">script</span>: string;</span><br><span class="line">  pos: number = <span class="number">0</span>;</span><br><span class="line">  state: DFAState = DFAState.Initial;</span><br><span class="line">  token: Token = <span class="keyword">new</span> Token();</span><br><span class="line">  tokenList: Token[] = [];</span><br><span class="line">  hexTemp = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  isDigit(ch: number): boolean &#123;</span><br><span class="line">    <span class="keyword">return</span> ch &gt; CharacterCodes._0 &amp;&amp; ch &lt; CharacterCodes._9;</span><br><span class="line">  &#125;</span><br><span class="line">  isHex(ch: number): boolean &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="built_in">this</span>.isDigit(ch) ||</span><br><span class="line">      (ch &gt;= CharacterCodes.a &amp;&amp; ch &lt;= CharacterCodes.f) ||</span><br><span class="line">      (ch &gt;= CharacterCodes.A &amp;&amp; ch &lt;= CharacterCodes.F)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">script: string</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.script = script;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">read</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.pos &lt; <span class="built_in">this</span>.script.length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.script.charCodeAt(<span class="built_in">this</span>.pos++);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> LexErrorType.EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getCh</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.script.substring(<span class="built_in">this</span>.pos - <span class="number">1</span>, <span class="built_in">this</span>.pos);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tokenize(): Token[] &#123;</span><br><span class="line">    <span class="keyword">let</span> ch;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> ((ch = <span class="built_in">this</span>.read())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">switch</span> (<span class="built_in">this</span>.state) &#123;</span><br><span class="line">            <span class="keyword">case</span> DFAState.Initial:</span><br><span class="line">            <span class="keyword">case</span> DFAState.OpenBracket:</span><br><span class="line">            <span class="keyword">case</span> DFAState.CloseBracket:</span><br><span class="line">            <span class="keyword">case</span> DFAState.OpenBraces:</span><br><span class="line">            <span class="keyword">case</span> DFAState.CloseBraces:</span><br><span class="line">            <span class="keyword">case</span> DFAState.Colon:</span><br><span class="line">            <span class="keyword">case</span> DFAState.Comma:</span><br><span class="line">            <span class="keyword">case</span> DFAState.StringEnd:</span><br><span class="line">              <span class="built_in">this</span>.initState(ch);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NumberMinus:</span><br><span class="line">              <span class="keyword">if</span> (ch === CharacterCodes._0) &#123;</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberZeroStart;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberNormal;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidNumber);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NumberZeroStart:</span><br><span class="line">              <span class="keyword">if</span> (ch === CharacterCodes.dot) &#123;</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberAfterDot;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.initState(ch);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NumberNormal:</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.dot) &#123;</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberDot;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.e || ch === CharacterCodes.E) &#123;</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberE;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.initState(ch);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NumberDot:</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberAfterDot;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidNumber);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NumberE:</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberAfterE;</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">                ch === CharacterCodes.plus ||</span><br><span class="line">                ch === CharacterCodes.minus</span><br><span class="line">              ) &#123;</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberESign;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidNumber);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NumberESign:</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberAfterE;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidNumber);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NumberAfterDot:</span><br><span class="line">              <span class="keyword">if</span> (ch === CharacterCodes.e || ch === CharacterCodes.E) &#123;</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.NumberE;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.initState(ch);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NumberAfterE:</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.initState(ch);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.StringNormal:</span><br><span class="line">              <span class="keyword">if</span> (ch &gt;= <span class="number">0</span> &amp;&amp; ch &lt;= <span class="number">0x1f</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidStringCharacter);</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.doubleQuote) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.StringEnd;</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.backslash) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.StringSlash;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.StringSlash:</span><br><span class="line">              <span class="keyword">if</span> (</span><br><span class="line">                [</span><br><span class="line">                  CharacterCodes.n,</span><br><span class="line">                  CharacterCodes.t,</span><br><span class="line">                  CharacterCodes.f,</span><br><span class="line">                  CharacterCodes.b,</span><br><span class="line">                  CharacterCodes.r,</span><br><span class="line">                  CharacterCodes.doubleQuote,</span><br><span class="line">                  CharacterCodes.slash,</span><br><span class="line">                  CharacterCodes.backslash,</span><br><span class="line">                ].includes(ch)</span><br><span class="line">              ) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.StringNormal;</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.u) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="built_in">this</span>.hexTemp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="built_in">this</span>.state = DFAState.StringSlashU;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidStringCharacter);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.StringSlashU:</span><br><span class="line">              <span class="keyword">const</span> character = <span class="built_in">this</span>.getCh();</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">this</span>.isHex(ch)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.token.value += character;</span><br><span class="line">                <span class="built_in">this</span>.hexTemp += character;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.hexTemp.length === <span class="number">4</span>) &#123;</span><br><span class="line">                  <span class="built_in">this</span>.state = DFAState.StringNormal;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidStringCharacter);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.NullType:</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">let</span> character = <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="keyword">if</span> (nullSteps.includes(<span class="built_in">this</span>.token.value + character)) &#123;</span><br><span class="line">                  <span class="built_in">this</span>.token.value += character;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="built_in">this</span>.token.value === <span class="string">&quot;null&quot;</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.initState(ch);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidKeyword);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.TrueType:</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">let</span> character = <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="keyword">if</span> (trueSteps.includes(<span class="built_in">this</span>.token.value + character)) &#123;</span><br><span class="line">                  <span class="built_in">this</span>.token.value += character;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="built_in">this</span>.token.value === <span class="string">&quot;true&quot;</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.initState(ch);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidKeyword);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DFAState.FalseType:</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">let</span> character = <span class="built_in">this</span>.getCh();</span><br><span class="line">                <span class="keyword">if</span> (falseSteps.includes(<span class="built_in">this</span>.token.value + character)) &#123;</span><br><span class="line">                  <span class="built_in">this</span>.token.value += character;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="built_in">this</span>.token.value === <span class="string">&quot;false&quot;</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.initState(ch);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.InvalidKeyword);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="keyword">if</span> (err <span class="keyword">instanceof</span> ErrorObject) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleError(err);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">case</span> LexErrorType.EOF:</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&quot;解析完毕&quot;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.tokenList.push(<span class="built_in">this</span>.token);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.tokenList;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">initState</span>(<span class="params">ch: any</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.token.value) &#123;</span><br><span class="line">      <span class="built_in">this</span>.tokenList.push(<span class="built_in">this</span>.token);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.token = <span class="keyword">new</span> Token();</span><br><span class="line">    <span class="keyword">if</span> (ch === CharacterCodes.doubleQuote) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.StringNormal;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.StringType;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.minus) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.NumberMinus;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.NumberType;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes._0) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.NumberZeroStart;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.NumberType;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isDigit(ch)) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.NumberNormal;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.NumberType;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.openBracket) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.OpenBracket;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.OpenBracket;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.closeBracket) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.CloseBracket;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.CloseBracket;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.openBrace) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.OpenBraces;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.OpenBraces;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.closeBrace) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.CloseBraces;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.CloseBraces;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.colon) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.Colon;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.Colon;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.comma) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.Comma;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.Comma;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.n) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.NullType;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.NullType;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.t) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.TrueType;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.TrueType;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch === CharacterCodes.f) &#123;</span><br><span class="line">      <span class="built_in">this</span>.state = DFAState.FalseType;</span><br><span class="line">      <span class="built_in">this</span>.token.type = TokenType.FalseType;</span><br><span class="line">      <span class="built_in">this</span>.token.value += <span class="built_in">this</span>.getCh();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wschar.includes(ch)) &#123;</span><br><span class="line">      <span class="comment">// 跳过空白字符</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ErrorObject(LexErrorType.UnexeceptedCharacter);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">handleError</span>(<span class="params">err: ErrorObject</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`在位置<span class="subst">$&#123;<span class="built_in">this</span>.pos - <span class="number">1</span>&#125;</span>遇到错误`</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`错误字符 <span class="subst">$&#123;<span class="built_in">this</span>.getCh()&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (err.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> LexErrorType.InvalidKeyword:</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;非法关键字&quot;</span>);</span><br><span class="line">      <span class="keyword">case</span> LexErrorType.UnexeceptedCharacter:</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;不被接受的字符: &quot;</span> + <span class="built_in">this</span>.getCh());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="parser"><a href="#parser" class="headerlink" title="parser"></a>parser</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Lexer &#125; <span class="keyword">from</span> <span class="string">&quot;./lexer&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Token, TokenType &#125; <span class="keyword">from</span> <span class="string">&quot;./token&quot;</span>;</span><br><span class="line"></span><br><span class="line">enum AstNodeType &#123;</span><br><span class="line">  JsonObject,</span><br><span class="line">  JsonObjectProperty,</span><br><span class="line">  JsonArray,</span><br><span class="line">  JsonString,</span><br><span class="line">  JsonNumber,</span><br><span class="line">  JsonTrueType,</span><br><span class="line">  JsonFalseType,</span><br><span class="line">  JsonNullType,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enum ParseErrorType &#123;</span><br><span class="line">  <span class="built_in">Error</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParseErrorObject</span> </span>&#123;</span><br><span class="line">  type!: ParseErrorType;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">type: ParseErrorType</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.type = type;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AstNode</span> </span>&#123;</span><br><span class="line">  <span class="attr">type</span>: AstNodeType | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  children: AstNode[] = [];</span><br><span class="line">  value: any = <span class="literal">undefined</span>;</span><br><span class="line">  parent: AstNode | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parser</span> </span>&#123;</span><br><span class="line">  <span class="attr">tokenList</span>: Token[];</span><br><span class="line">  pos = <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="title">peek</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.tokenList[<span class="built_in">this</span>.pos];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">read</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.tokenList[<span class="built_in">this</span>.pos++];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">tokenList: any[]</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.tokenList = tokenList;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseProgram</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> parseResult = <span class="built_in">this</span>.parseValue() <span class="keyword">as</span> AstNode;</span><br><span class="line">      <span class="keyword">return</span> parseResult.value;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;错误位置&quot;</span>, <span class="built_in">this</span>.pos, <span class="built_in">this</span>.read());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseValue</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> parseResult;</span><br><span class="line">    parseResult = <span class="built_in">this</span>.parseNumber();</span><br><span class="line">    <span class="keyword">if</span> (parseResult !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> parseResult;</span><br><span class="line">    &#125;</span><br><span class="line">    parseResult = <span class="built_in">this</span>.parseString();</span><br><span class="line">    <span class="keyword">if</span> (parseResult !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> parseResult;</span><br><span class="line">    &#125;</span><br><span class="line">    parseResult = <span class="built_in">this</span>.parseTrueType();</span><br><span class="line">    <span class="keyword">if</span> (parseResult !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> parseResult;</span><br><span class="line">    &#125;</span><br><span class="line">    parseResult = <span class="built_in">this</span>.parseFalseType();</span><br><span class="line">    <span class="keyword">if</span> (parseResult !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> parseResult;</span><br><span class="line">    &#125;</span><br><span class="line">    parseResult = <span class="built_in">this</span>.parseNullType();</span><br><span class="line">    <span class="keyword">if</span> (parseResult !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> parseResult;</span><br><span class="line">    &#125;</span><br><span class="line">    parseResult = <span class="built_in">this</span>.parseArray();</span><br><span class="line">    <span class="keyword">if</span> (parseResult !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> parseResult;</span><br><span class="line">    &#125;</span><br><span class="line">    parseResult = <span class="built_in">this</span>.parseObject();</span><br><span class="line">    <span class="keyword">if</span> (parseResult !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> parseResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ParseErrorObject(ParseErrorType.Error);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseObject</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> astNode = <span class="keyword">new</span> AstNode();</span><br><span class="line">    astNode.type = AstNodeType.JsonObject;</span><br><span class="line">    astNode.value = &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.OpenBraces) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.read();</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type === TokenType.CloseBraces) &#123;</span><br><span class="line">        <span class="built_in">this</span>.read();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> properyAstNode = <span class="built_in">this</span>.parseObjectProperty() <span class="keyword">as</span> AstNode;</span><br><span class="line">      properyAstNode.parent = astNode;</span><br><span class="line">      astNode.children.push(properyAstNode);</span><br><span class="line">      astNode.value[properyAstNode.value[<span class="number">0</span>]] = properyAstNode.value[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type === TokenType.Comma) &#123;</span><br><span class="line">        <span class="built_in">this</span>.read();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type === TokenType.CloseBraces) &#123;</span><br><span class="line">          <span class="built_in">this</span>.read();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ParseErrorObject(ParseErrorType.Error);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> astNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseArray</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> astNode = <span class="keyword">new</span> AstNode();</span><br><span class="line">    astNode.type = AstNodeType.JsonArray;</span><br><span class="line">    astNode.value = [];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.OpenBracket) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.read();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type === TokenType.CloseBracket) &#123;</span><br><span class="line">        <span class="built_in">this</span>.read();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> valueAstNode = <span class="built_in">this</span>.parseValue() <span class="keyword">as</span> AstNode;</span><br><span class="line">      valueAstNode.parent = astNode;</span><br><span class="line">      astNode.children.push(valueAstNode);</span><br><span class="line">      astNode.value.push(valueAstNode.value);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type === TokenType.Comma) &#123;</span><br><span class="line">        <span class="built_in">this</span>.read();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type === TokenType.CloseBracket) &#123;</span><br><span class="line">          <span class="built_in">this</span>.read();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ParseErrorObject(ParseErrorType.Error);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> astNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseObjectProperty</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.StringType) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> propertyNameToken = <span class="built_in">this</span>.read();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.Colon) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ParseErrorObject(ParseErrorType.Error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.read();</span><br><span class="line">    <span class="keyword">const</span> valueAstNode = <span class="built_in">this</span>.parseValue() <span class="keyword">as</span> AstNode;</span><br><span class="line">    <span class="keyword">const</span> astNode = <span class="keyword">new</span> AstNode();</span><br><span class="line">    astNode.type = AstNodeType.JsonObjectProperty;</span><br><span class="line">    valueAstNode.parent = astNode;</span><br><span class="line">    astNode.children.push(valueAstNode);</span><br><span class="line">    astNode.value = [<span class="built_in">JSON</span>.parse(propertyNameToken.value), valueAstNode.value];</span><br><span class="line">    <span class="keyword">return</span> astNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseNumber</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.NumberType) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> astNode = <span class="keyword">new</span> AstNode();</span><br><span class="line">    astNode.type = AstNodeType.JsonNumber;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="built_in">this</span>.read();</span><br><span class="line">    astNode.value = <span class="built_in">JSON</span>.parse(token.value);</span><br><span class="line">    <span class="keyword">return</span> astNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseString</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.StringType) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> astNode = <span class="keyword">new</span> AstNode();</span><br><span class="line">    astNode.type = AstNodeType.JsonString;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="built_in">this</span>.read();</span><br><span class="line">    astNode.value = <span class="built_in">JSON</span>.parse(token.value);</span><br><span class="line">    <span class="keyword">return</span> astNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseTrueType</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.TrueType) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> astNode = <span class="keyword">new</span> AstNode();</span><br><span class="line">    astNode.type = AstNodeType.JsonTrueType;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="built_in">this</span>.read();</span><br><span class="line">    astNode.value = <span class="built_in">JSON</span>.parse(token.value);</span><br><span class="line">    <span class="keyword">return</span> astNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseFalseType</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.FalseType) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> astNode = <span class="keyword">new</span> AstNode();</span><br><span class="line">    astNode.type = AstNodeType.JsonFalseType;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="built_in">this</span>.read();</span><br><span class="line">    astNode.value = <span class="built_in">JSON</span>.parse(token.value);</span><br><span class="line">    <span class="keyword">return</span> astNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">parseNullType</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.peek().type !== TokenType.NullType) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> astNode = <span class="keyword">new</span> AstNode();</span><br><span class="line">    astNode.type = AstNodeType.JsonNullType;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="built_in">this</span>.read();</span><br><span class="line">    astNode.value = <span class="built_in">JSON</span>.parse(token.value);</span><br><span class="line">    <span class="keyword">return</span> astNode;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> lexer = <span class="keyword">new</span> Lexer(</span><br><span class="line">  <span class="string">`&#123;&quot;name&quot;:&quot;\\n\\uaaaatest project&quot;,\n\n&quot;number&quot;:1.5E5,  &quot;array&quot;:[1,2,true],      &quot;description&quot;:&quot;test project&quot;,&quot;private&quot;:true,&quot;workspaces&quot;:&#123;&quot;shell&quot;:&quot;shell&quot;&#125;&#125;`</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tokenList = lexer.tokenize();</span><br><span class="line"></span><br><span class="line">tokenList.forEach(<span class="function">(<span class="params">token, index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    index,</span><br><span class="line">    token.value.padEnd(<span class="number">20</span>, <span class="string">&quot; &quot;</span>),</span><br><span class="line">    TokenType[token.type <span class="keyword">as</span> TokenType]</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parser = <span class="keyword">new</span> Parser(tokenList);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(parser.parseProgram());</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/01/31/vue/vue-composition-api%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bwatch%E4%B8%8Ecomputed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/31/vue/vue-composition-api%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bwatch%E4%B8%8Ecomputed/" class="post-title-link" itemprop="url">vue-composition-api源码分析之watch与computed</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-31 22:18:08" itemprop="dateCreated datePublished" datetime="2021-01-31T22:18:08+00:00">2021-01-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-21 16:45:16" itemprop="dateModified" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue/" itemprop="url" rel="index"><span itemprop="name">vue</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">1.6k(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">8(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇基本上搞懂了怎么定义响应式对象的，这里研究一下怎么触发侦测的</p>
<h2 id="api-watch-ts"><a href="#api-watch-ts" class="headerlink" title="api/watch.ts"></a>api/watch.ts</h2><h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><p>之前比较疑惑的是，为什么 watch 的第一个参数需要传递一个 getter 或者 ref，而不能传递 <code>reactive.prop</code>。<br>其实这里是调用了 Vue.$watch 方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/apis/watch.ts</span></span><br><span class="line"><span class="keyword">const</span> stop = vm.$watch(getter, callback, &#123;</span><br><span class="line">  <span class="attr">immediate</span>: options.immediate,</span><br><span class="line">  <span class="attr">deep</span>: deep,</span><br><span class="line">  <span class="attr">sync</span>: isSync,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// vue/src/core/instance/state.js</span></span><br><span class="line">Vue.prototype.$watch = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    expOrFn: <span class="built_in">string</span> | <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    cb: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    options?: <span class="built_in">Object</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> vm: Component = <span class="built_in">this</span></span><br><span class="line">    <span class="keyword">if</span> (isPlainObject(cb)) &#123;</span><br><span class="line">      <span class="keyword">return</span> createWatcher(vm, expOrFn, cb, options)</span><br><span class="line">    &#125;</span><br><span class="line">    options = options || &#123;&#125;</span><br><span class="line">    options.user = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> Watcher(vm, expOrFn, cb, options)</span><br><span class="line">    <span class="keyword">if</span> (options.immediate) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cb.call(vm, watcher.value)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        handleError(error, vm, <span class="string">`callback for immediate watcher &quot;<span class="subst">$&#123;watcher.expression&#125;</span>&quot;`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unwatchFn</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      watcher.teardown()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// vue/src/core/observer/watcher.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ... 省略各种定义</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    vm: Component,</span></span></span><br><span class="line"><span class="params"><span class="function">    expOrFn: <span class="built_in">string</span> | <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    cb: <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    options?: ?<span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    isRenderWatcher?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 省略无关内容</span></span><br><span class="line">    <span class="comment">// parse expression for getter</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.getter = expOrFn;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.getter = parsePath(expOrFn);</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.getter) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getter = noop;</span><br><span class="line">        <span class="comment">// 开发环境下警告 省略</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.value = <span class="built_in">this</span>.lazy ? <span class="literal">undefined</span> : <span class="built_in">this</span>.get();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    pushTarget(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">let</span> value;</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="built_in">this</span>.vm;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      value = <span class="built_in">this</span>.getter.call(vm, vm);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.user) &#123;</span><br><span class="line">        handleError(e, vm, <span class="string">`getter for watcher &quot;<span class="subst">$&#123;<span class="built_in">this</span>.expression&#125;</span>&quot;`</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// &quot;touch&quot; every property so they are all tracked as</span></span><br><span class="line">      <span class="comment">// dependencies for deep watching</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.deep) &#123;</span><br><span class="line">        traverse(value);</span><br><span class="line">      &#125;</span><br><span class="line">      popTarget();</span><br><span class="line">      <span class="built_in">this</span>.cleanupDeps();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 $watch 要求传入 getter 或者一个路径字符串，这个 getter 是要在进行依赖收集的时候被调用的<br>composition-api 中的 watch 使用了 vue2 自身的 watch 机制</p>
<p>至于 watch 的响应式原理，大致如下吧</p>
<p><img src="/2021/01/31/vue/vue-composition-api%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bwatch%E4%B8%8Ecomputed/watch.png" alt="watch"></p>
<p>通过看源码也搞清了一个点，这里的 childObj 和深度监听一点关系都没有</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue/src/core/observer/index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  obj: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  key: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  val: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  customSetter?: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  shallow?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 无关代码 略过</span></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; observe(val);</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val;</span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">        dep.depend();</span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.dep.depend();</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">            dependArray(value);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 无关代码 略过</span></span><br></pre></td></tr></table></figure>
<p>它的作用是：每个 Observer 对象都有一个 dep 属性，如果使用 Vue.$set 给对象动态添加新属性，会给赋予该属性响应式并调用该对象的 dep 的 notify</p>
<p>看下面的例子应该就可以完全理解了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">ttt</span>: &#123;</span><br><span class="line">        <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.ttt.a = <span class="number">3</span>; <span class="comment">// 无法触发 watch</span></span><br><span class="line">      <span class="built_in">this</span>.$set(<span class="built_in">this</span>.ttt, <span class="string">&quot;a&quot;</span>, <span class="number">5</span>); <span class="comment">// 无法触发 watch 因为不是新属性，直接赋值后就返回了</span></span><br><span class="line">      <span class="built_in">this</span>.$set(<span class="built_in">this</span>.ttt, <span class="string">&quot;b&quot;</span>, <span class="number">5</span>); <span class="comment">// 可以触发，因为 ttt 的 __ob__ 上的 dep 调用了 notify</span></span><br><span class="line">      <span class="built_in">this</span>.ttt = &#123;&#125;; <span class="comment">// 可以触发</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">watch</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">ttt</span>(<span class="params">val</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;watch&quot;</span>, val);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>那么看一下深度监听是怎么实现的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue/src/core/observer/watcher.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    pushTarget(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">let</span> value;</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="built_in">this</span>.vm;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      value = <span class="built_in">this</span>.getter.call(vm, vm);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.user) &#123;</span><br><span class="line">        handleError(e, vm, <span class="string">`getter for watcher &quot;<span class="subst">$&#123;<span class="built_in">this</span>.expression&#125;</span>&quot;`</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// &quot;touch&quot; every property so they are all tracked as</span></span><br><span class="line">      <span class="comment">// dependencies for deep watching</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.deep) &#123;</span><br><span class="line">        traverse(value);</span><br><span class="line">      &#125;</span><br><span class="line">      popTarget();</span><br><span class="line">      <span class="built_in">this</span>.cleanupDeps();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">traverse</span>(<span class="params">val: any</span>) </span>&#123;</span><br><span class="line">  _traverse(val, seenObjects);</span><br><span class="line">  seenObjects.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_traverse</span>(<span class="params">val: any, seen: SimpleSet</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i, keys;</span><br><span class="line">  <span class="keyword">const</span> isA = <span class="built_in">Array</span>.isArray(val);</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (!isA &amp;&amp; !isObject(val)) ||</span><br><span class="line">    <span class="built_in">Object</span>.isFrozen(val) ||</span><br><span class="line">    val <span class="keyword">instanceof</span> VNode</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (val.__ob__) &#123;</span><br><span class="line">    <span class="keyword">const</span> depId = val.__ob__.dep.id;</span><br><span class="line">    <span class="keyword">if</span> (seen.has(depId)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    seen.add(depId);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isA) &#123;</span><br><span class="line">    i = val.length;</span><br><span class="line">    <span class="keyword">while</span> (i--) _traverse(val[i], seen);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    keys = <span class="built_in">Object</span>.keys(val);</span><br><span class="line">    i = keys.length;</span><br><span class="line">    <span class="keyword">while</span> (i--) _traverse(val[keys[i]], seen);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是递归遍历，深度访问对象所有的值，触发对象所有值的依赖收集。<br>还有一个点，Vue.$watch 返回了一个方法用于停止监听，看下它是怎么实现的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue/src/core/instance/state.js</span></span><br><span class="line">Vue.prototype.$watch = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  expOrFn: string | <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  cb: any,</span></span></span><br><span class="line"><span class="params"><span class="function">  options?: <span class="built_in">Object</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 省略</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unwatchFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    watcher.teardown();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// vue/src/core/observer/watcher.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">teardown</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.active) &#123;</span><br><span class="line">      <span class="comment">// remove self from vm&#x27;s watcher list</span></span><br><span class="line">      <span class="comment">// this is a somewhat expensive operation so we skip it</span></span><br><span class="line">      <span class="comment">// if the vm is being destroyed.</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.vm._isBeingDestroyed) &#123;</span><br><span class="line">        remove(<span class="built_in">this</span>.vm._watchers, <span class="built_in">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> i = <span class="built_in">this</span>.deps.length;</span><br><span class="line">      <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="built_in">this</span>.deps[i].removeSub(<span class="built_in">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.active = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// vue/src/core/observer/dep.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">removeSub</span>(<span class="params">sub: Watcher</span>)</span> &#123;</span><br><span class="line">    remove(<span class="built_in">this</span>.subs, sub);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// vue/src/shared/util.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove an item from an array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params">arr: <span class="built_in">Array</span>&lt;any&gt;, item: any</span>): <span class="title">Array</span>&lt;<span class="title">any</span>&gt; | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (arr.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = arr.indexOf(item);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> arr.splice(index, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是把 watcher 从所有依赖的属性的 subs 中删除</p>
<h3 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/apis/computed.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computed</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  options: Option&lt;T&gt;[<span class="string">&quot;get&quot;</span>] | Option&lt;T&gt;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">ComputedRef</span>&lt;<span class="title">T</span>&gt; | <span class="title">WritableComputedRef</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm = getCurrentInstance()?.proxy;</span><br><span class="line">  <span class="keyword">let</span> get: Option&lt;T&gt;[<span class="string">&quot;get&quot;</span>], <span class="attr">set</span>: Option&lt;T&gt;[<span class="string">&quot;set&quot;</span>] | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">    get = options;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    get = options.get;</span><br><span class="line">    set = options.set;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> computedSetter;</span><br><span class="line">  <span class="keyword">let</span> computedGetter;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (vm &amp;&amp; !vm.$isServer) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; Watcher, Dep &#125; = getVueInternalClasses();</span><br><span class="line">    <span class="keyword">let</span> watcher: <span class="built_in">any</span>;</span><br><span class="line">    computedGetter = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!watcher) &#123;</span><br><span class="line">        watcher = <span class="keyword">new</span> Watcher(vm, get, noopFn, &#123; <span class="attr">lazy</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (watcher.dirty) &#123;</span><br><span class="line">        watcher.evaluate();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">        watcher.depend();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> watcher.value;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    computedSetter = <span class="function">(<span class="params">v: T</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (set) &#123;</span><br><span class="line">        set(v);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// fallback</span></span><br><span class="line">    <span class="keyword">const</span> computedHost = defineComponentInstance(getVueConstructor(), &#123;</span><br><span class="line">      <span class="attr">computed</span>: &#123;</span><br><span class="line">        <span class="attr">$$state</span>: &#123;</span><br><span class="line">          get,</span><br><span class="line">          set,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    vm &amp;&amp; vm.$on(<span class="string">&quot;hook:destroyed&quot;</span>, <span class="function">() =&gt;</span> computedHost.$destroy());</span><br><span class="line"></span><br><span class="line">    computedGetter = <span class="function">() =&gt;</span> (computedHost <span class="keyword">as</span> <span class="built_in">any</span>).$$state;</span><br><span class="line">    computedSetter = <span class="function">(<span class="params">v: T</span>) =&gt;</span> &#123;</span><br><span class="line">      (computedHost <span class="keyword">as</span> <span class="built_in">any</span>).$$state = v;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createRef&lt;T&gt;(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">get</span>: computedGetter,</span><br><span class="line">      <span class="attr">set</span>: computedSetter,</span><br><span class="line">    &#125;,</span><br><span class="line">    !set</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 createRef 传递 get 和 set 创建了 Ref。<br>computed 是惰性的（初始时 lazy 和 dirty 都为 true），只有在被求值的时候才会计算，然后进行相应的依赖收集</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (watcher.dirty) &#123;</span><br><span class="line">  watcher.evaluate();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">  watcher.depend();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有点难理解的，其实是对应了这种情况</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;App&quot;</span>,</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">t</span>: <span class="number">5</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.t = <span class="number">10</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="built_in">this</span>.tttt);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">computed</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">tt</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.t;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">ttt</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.tt;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当 computed 依赖于另外的 computed 时，访问 t 的 getter 只会给 tt 的 watcher 添加订阅，但是我们想要的给 tt 和 ttt 的 watcher 都添加订阅<br>Vue 对于 Dep.target 使用了一个栈去管理，而这种嵌套的 computed 的访问也是栈式的。<br>访问 ttt 的 getter 时，执行 ttt 的 watcher 的 evaluate()，ttt 的 watcher 入栈，然后嵌套访问 tt 的 getter，然后执行 tt 的 watcher 的 evaluate()，tt 的 watcher 入栈。tt 这一层的 evaluate() 执行完毕后 tt 的 watcher 退栈，这时 Dep.target 是指向 ttt.watcher 的，执行 watcher.depend()，就可以给 ttt 的 watcher 添加订阅了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.jiezi19971225.cn/2021/01/31/vue/vue-composition-api%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Breactive%E4%B8%8Eref/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jiezi19971225">
      <meta itemprop="description" content="记录编程学习路上的点滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiez19971225‘s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/31/vue/vue-composition-api%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Breactive%E4%B8%8Eref/" class="post-title-link" itemprop="url">vue-composition-api源码分析之reactive与ref</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-31 22:17:55" itemprop="dateCreated datePublished" datetime="2021-01-31T22:17:55+00:00">2021-01-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-21 16:45:16" itemprop="dateModified" datetime="2021-10-21T16:45:16+00:00">2021-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue/" itemprop="url" rel="index"><span itemprop="name">vue</span></a>
                </span>
            </span>

          

          <span class="post-time">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-bar-chart"></i>
            </span>
            <span class="post-meta-item-text">字数统计:</span>
            <span class="post-count">2.6k(字)</span>

          </span>

            <span class="post-time">
          &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长:</span>
            <span class="post-count">13(分)</span>

          </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>分析的是 @vue/composition-api 的代码，版本是 V1.0.0-rc.1<br>vue 的版本是 2.6.12</p>
<p>因为对于 reactive 和 ref 各自的行为和用法尚有不明之处，所以看一下源码，记录一下笔记</p>
<p>文件结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├─scripts</span><br><span class="line">├─src</span><br><span class="line">│  ├─apis</span><br><span class="line">│  ├─component</span><br><span class="line">│  ├─reactivity</span><br><span class="line">│  ├─types</span><br><span class="line">│  └─utils</span><br><span class="line">├─test</span><br><span class="line">│  ├─apis</span><br><span class="line">│  ├─helpers</span><br><span class="line">│  ├─ssr</span><br><span class="line">│  ├─types</span><br><span class="line">│  └─v3</span><br><span class="line">│      ├─reactivity</span><br><span class="line">│      └─runtime-core</span><br><span class="line">└─test-dts</span><br></pre></td></tr></table></figure>
<p>这次主要关注 src/reactivity 和 src/apis 中的代码</p>
<h2 id="reactivity-reactive-ts"><a href="#reactivity-reactive-ts" class="headerlink" title="reactivity/reactive.ts"></a>reactivity/reactive.ts</h2><h3 id="reactive"><a href="#reactive" class="headerlink" title="reactive"></a>reactive</h3><p>reactive 和 ref 相关的方法在 reactivity 目录下</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/reactive.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params">obj: T</span>): <span class="title">UnwrapRef</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !(isPlainObject(obj) || isArray(obj)) ||</span><br><span class="line">    isRaw(obj) ||</span><br><span class="line">    !<span class="built_in">Object</span>.isExtensible(obj)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> obj <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> observed = observe(obj);</span><br><span class="line">  setupAccessControl(observed);</span><br><span class="line">  <span class="keyword">return</span> observed <span class="keyword">as</span> UnwrapRef&lt;T&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是看 observe 是啥</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/reactive.ts</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> Vue = getRegisteredVueOrDefault();</span><br><span class="line">  <span class="keyword">var</span> observed;</span><br><span class="line">  <span class="keyword">if</span> (Vue.observable) &#123;</span><br><span class="line">    observed = Vue.observable(obj);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> vm = defineComponentInstance(Vue, &#123;</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">$$state</span>: obj,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    observed = vm._data.$$state;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// in SSR, there is no __ob__. Mock for reactivity check</span></span><br><span class="line">  <span class="keyword">if</span> (!hasOwn(observed, <span class="string">&quot;__ob__&quot;</span>)) &#123;</span><br><span class="line">    def(observed, <span class="string">&quot;__ob__&quot;</span>, mockObserver(observed));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> observed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 Vue 上有 Vue.observe，使用 Vue.observe</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue/src/core/global-api/index.js</span></span><br><span class="line">Vue.observable = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  observe(obj);</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Vue.observe 直接返回了传入的对象，也就是说，<strong>reactive 的作用只是给对象增加响应式，返回的值是对象本身</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue/src/core/observer/index.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">value, asRootData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(value) || value <span class="keyword">instanceof</span> VNode) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> ob;</span><br><span class="line">  <span class="keyword">if</span> (hasOwn(value, <span class="string">&quot;__ob__&quot;</span>) &amp;&amp; value.__ob__ <span class="keyword">instanceof</span> Observer) &#123;</span><br><span class="line">    ob = value.__ob__;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !isServerRendering() &amp;&amp;</span><br><span class="line">    (<span class="built_in">Array</span>.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">    <span class="built_in">Object</span>.isExtensible(value) &amp;&amp;</span><br><span class="line">    !value._isVue</span><br><span class="line">  ) &#123;</span><br><span class="line">    ob = <span class="keyword">new</span> Observer(value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.vmCount++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果之前没有被 observe 过，使用 new Observer(value) 添加响应式属性，否则什么都不做</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue/src/core/observer/index.js</span></span><br><span class="line"><span class="keyword">var</span> Observer = <span class="function"><span class="keyword">function</span> <span class="title">Observer</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.value = value;</span><br><span class="line">  <span class="built_in">this</span>.dep = <span class="keyword">new</span> Dep();</span><br><span class="line">  <span class="built_in">this</span>.vmCount = <span class="number">0</span>;</span><br><span class="line">  def(value, <span class="string">&quot;__ob__&quot;</span>, <span class="built_in">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">      protoAugment(value, arrayMethods);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      copyAugment(value, arrayMethods, arrayKeys);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.observeArray(value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.walk(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到这个构造方法给对象增加了 <code>__ob__</code>属性。</p>
<p>那么看以下代码</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = &#123;</span><br><span class="line">  <span class="attr">a</span>: <span class="number">100</span>,</span><br><span class="line">);</span><br><span class="line"><span class="keyword">let</span> b = reactive(a);</span><br><span class="line">reactive(b)</span><br></pre></td></tr></table></figure>
<p>这么使用 reactive 是没问题的，同时 a，b 这里指向的时同一个响应式对象，reactive(b) 这句实际上没有任何作用</p>
<p>显然我们不能重新给 a 或 b 赋值，因为响应性是赋予在 a，b 指向的对象上的</p>
<p>然后看下 setupAccessControl 干了什么</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/reactive.ts</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupAccessControl</span>(<span class="params">target: AnyObject</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !isPlainObject(target) ||</span><br><span class="line">    isRaw(target) ||</span><br><span class="line">    <span class="built_in">Array</span>.isArray(target) ||</span><br><span class="line">    isRef(target) ||</span><br><span class="line">    isComponentInstance(target) ||</span><br><span class="line">    accessModifiedSet.has(target)</span><br><span class="line">  )</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  accessModifiedSet.set(target, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(target);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    defineAccessControl(target, keys[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>accessModifiedSet 是一个 weakmap，如果之前对对象设置过，就不再设置了<br>对对象的每一个属性调用 defineAccessControl</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/reactive.ts</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto unwrapping when access property</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineAccessControl</span>(<span class="params">target: AnyObject, key: <span class="built_in">any</span>, val?: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (key === <span class="string">&quot;__ob__&quot;</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (isRaw(target[key])) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> getter: (<span class="function">() =&gt;</span> <span class="built_in">any</span>) | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">let</span> setter: (<span class="function">(<span class="params">x: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>) | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(target, key);</span><br><span class="line">  <span class="keyword">if</span> (property) &#123;</span><br><span class="line">    <span class="keyword">if</span> (property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    getter = property.get;</span><br><span class="line">    setter = property.set;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (!getter || setter) <span class="comment">/* not only have getter */</span> &amp;&amp;</span><br><span class="line">      <span class="built_in">arguments</span>.length === <span class="number">2</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      val = target[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果 val 是一个对象 递归调用 defineAccessControl</span></span><br><span class="line">  setupAccessControl(val);</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="function"><span class="keyword">function</span> <span class="title">getterHandler</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(target) : val;</span><br><span class="line">      <span class="comment">// if the key is equal to RefKey, skip the unwrap logic</span></span><br><span class="line">      <span class="keyword">if</span> (key !== RefKey &amp;&amp; isRef(value)) &#123;</span><br><span class="line">        <span class="keyword">return</span> value.value;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="function"><span class="keyword">function</span> <span class="title">setterHandler</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(target) : val;</span><br><span class="line">      <span class="comment">// If the key is equal to RefKey, skip the unwrap logic</span></span><br><span class="line">      <span class="comment">// If and only if &quot;value&quot; is ref and &quot;newVal&quot; is not a ref,</span></span><br><span class="line">      <span class="comment">// the assignment should be proxied to &quot;value&quot; ref.</span></span><br><span class="line">      <span class="keyword">if</span> (key !== RefKey &amp;&amp; isRef(value) &amp;&amp; !isRef(newVal)) &#123;</span><br><span class="line">        value.value = newVal;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        setter.call(target, newVal);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal;</span><br><span class="line">      &#125;</span><br><span class="line">      setupAccessControl(newVal);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupAccessControl</span>(<span class="params">target: AnyObject</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !isPlainObject(target) ||</span><br><span class="line">    isRaw(target) ||</span><br><span class="line">    <span class="built_in">Array</span>.isArray(target) ||</span><br><span class="line">    isRef(target) ||</span><br><span class="line">    isComponentInstance(target) ||</span><br><span class="line">    accessModifiedSet.has(target)</span><br><span class="line">  )</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  accessModifiedSet.set(target, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(target);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    defineAccessControl(target, keys[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 val 是一个对象 递归调用 defineAccessControl<br>defineAccessControl 的作用是 reactive 对象在读写属性时，如果属性是一个 Ref 对象，可以自动拆装箱</p>
<h3 id="shallowReactive"><a href="#shallowReactive" class="headerlink" title="shallowReactive"></a>shallowReactive</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/reactive.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shallowReactive</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !(isPlainObject(obj) || isArray(obj)) ||</span><br><span class="line">    isRaw(obj) ||</span><br><span class="line">    !<span class="built_in">Object</span>.isExtensible(obj)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> obj <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> observed = observe(&#123;&#125;);</span><br><span class="line">  setupAccessControl(observed);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ob = (observed <span class="keyword">as</span> <span class="built_in">any</span>).__ob__;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> <span class="built_in">Object</span>.keys(obj)) &#123;</span><br><span class="line">    <span class="keyword">let</span> val = obj[key];</span><br><span class="line">    <span class="keyword">let</span> getter: (<span class="function">() =&gt;</span> <span class="built_in">any</span>) | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">let</span> setter: (<span class="function">(<span class="params">x: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>) | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key);</span><br><span class="line">    <span class="keyword">if</span> (property) &#123;</span><br><span class="line">      <span class="keyword">if</span> (property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      getter = property.get;</span><br><span class="line">      setter = property.set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(observed, key, &#123;</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">get</span>: <span class="function"><span class="keyword">function</span> <span class="title">getterHandler</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> value = getter ? getter.call(obj) : val;</span><br><span class="line">        ob.dep?.depend();</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">set</span>: <span class="function"><span class="keyword">function</span> <span class="title">setterHandler</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">          setter.call(obj, newVal);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          val = newVal;</span><br><span class="line">        &#125;</span><br><span class="line">        ob.dep?.notify();</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> observed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只对响应式对象的属性手动设置响应式并管理依赖收集，如果属性是对象，不会深度添加响应式</p>
<h3 id="isReactive"><a href="#isReactive" class="headerlink" title="isReactive"></a>isReactive</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/reactive.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Boolean</span>(obj?.__ob__ &amp;&amp; !obj.__ob__?.__raw__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是看对象是否有 <code>__ob__</code> 属性并且没有使用 markRaw 标记</p>
<h3 id="markRaw-amp-amp-isRaw-amp-amp-toRaw"><a href="#markRaw-amp-amp-isRaw-amp-amp-toRaw" class="headerlink" title="markRaw &amp;&amp; isRaw &amp;&amp; toRaw"></a>markRaw &amp;&amp; isRaw &amp;&amp; toRaw</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/reactive.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markRaw</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params">obj: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(isPlainObject(obj) || isArray(obj)) || !<span class="built_in">Object</span>.isExtensible(obj)) &#123;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the vue observable flag at obj</span></span><br><span class="line">  <span class="keyword">const</span> ob = createObserver();</span><br><span class="line">  ob.__raw__ = <span class="literal">true</span>;</span><br><span class="line">  def(obj, <span class="string">&quot;__ob__&quot;</span>, ob);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mark as Raw</span></span><br><span class="line">  rawSet.set(obj, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isRaw</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Boolean</span>(obj?.__ob__ &amp;&amp; obj.__ob__?.__raw__);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRaw</span>&lt;<span class="title">T</span>&gt;(<span class="params">observed: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isRaw(observed) || !<span class="built_in">Object</span>.isExtensible(observed)) &#123;</span><br><span class="line">    <span class="keyword">return</span> observed;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (observed <span class="keyword">as</span> <span class="built_in">any</span>)?.__ob__?.value || observed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>markRaw 给目标添加了 vue observable 的 flag，这样 Vue 应该就不会再给对象添加响应式属性了<br>rawSet 也是一个 weakmap<br>isRaw 通过 markRaw 设置的 <code>__ob__.__raw__</code> flag 来判断<br>toRaw 是获取响应式对象的原本对象<br>这里 和 vue3 实现的有些差异，通过之前我们知道 reactive 是在原对象上增加响应式属性<code>__ob__</code>的，而 vue3 是通过 proxy 实现的，所以 toRaw 拿到的是被代理的原始对象,而这里这个 toRaw 有点意义不明</p>
<h2 id="reactivity-ref-ts"><a href="#reactivity-ref-ts" class="headerlink" title="reactivity/ref.ts"></a>reactivity/ref.ts</h2><p>这个文件上来就是一堆类型定义，看的我人晕掉了。。</p>
<h3 id="ref-amp-amp-isRef"><a href="#ref-amp-amp-isRef" class="headerlink" title="ref &amp;&amp; isRef"></a>ref &amp;&amp; isRef</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RefKey = <span class="string">&quot;composition-api.refKey&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  raw: T</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">T</span> <span class="title">extends</span> <span class="title">Ref</span> ? <span class="title">T</span> : <span class="title">Ref</span>&lt;<span class="title">UnwrapRef</span>&lt;<span class="title">T</span>&gt;&gt;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>&lt;<span class="title">T</span>&gt;(<span class="params">raw: T</span>): <span class="title">Ref</span>&lt;<span class="title">UnwrapRef</span>&lt;<span class="title">T</span>&gt;&gt;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>&lt;<span class="title">T</span> = <span class="title">any</span>&gt;(<span class="params"></span>): <span class="title">Ref</span>&lt;<span class="title">T</span> | <span class="title">undefined</span>&gt;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">raw?: unknown</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isRef(raw)) &#123;</span><br><span class="line">    <span class="keyword">return</span> raw;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> value = reactive(&#123; [RefKey]: raw &#125;);</span><br><span class="line">  <span class="keyword">return</span> createRef(&#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> value[RefKey] <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">    <span class="attr">set</span>: <span class="function">(<span class="params">v</span>) =&gt;</span> ((value[RefKey] <span class="keyword">as</span> <span class="built_in">any</span>) = v),</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好家伙，上来就是三个重载，然后 <code>Ref&lt;UnwrapRef&lt;T&gt;&gt;</code>这玩意好绕，先不管了<br>如果传入的对象已经是 Ref 对象，直接返回，否则通过 reactive 创建一个响应式对象，然后返回通过 createRef 创建的对象</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isRef</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: <span class="built_in">any</span></span>): <span class="title">value</span> <span class="title">is</span> <span class="title">Ref</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> value <span class="keyword">instanceof</span> RefImpl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 instanceOf 判断是否是 Ref 对象是</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRef</span>&lt;<span class="title">T</span>&gt;(<span class="params">options: RefOption&lt;T&gt;, <span class="keyword">readonly</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">new</span> RefImpl&lt;T&gt;(options);</span><br><span class="line">  <span class="comment">// seal the ref, this could prevent ref from being observed</span></span><br><span class="line">  <span class="comment">// It&#x27;s safe to seal the ref, since we really shouldn&#x27;t extend it.</span></span><br><span class="line">  <span class="comment">// related issues: #79</span></span><br><span class="line">  <span class="keyword">const</span> sealed = <span class="built_in">Object</span>.seal(r);</span><br><span class="line"></span><br><span class="line">  readonlySet.set(sealed, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">return</span> sealed;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefImpl</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">Ref</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">readonly</span> [_refBrand]!: <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">public</span> value!: T;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">&#123; get, set &#125;: RefOption&lt;T&gt;</span>)</span> &#123;</span><br><span class="line">    proxy(<span class="built_in">this</span>, <span class="string">&quot;value&quot;</span>, &#123;</span><br><span class="line">      get,</span><br><span class="line">      set,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> sharedPropertyDefinition = &#123;</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">get</span>: noopFn,</span><br><span class="line">  <span class="attr">set</span>: noopFn,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  target: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  key: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  &#123; get, set &#125;: &#123; get?: <span class="built_in">Function</span>; set?: <span class="built_in">Function</span> &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  sharedPropertyDefinition.get = get || noopFn;</span><br><span class="line">  sharedPropertyDefinition.set = set || noopFn;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>createRef 就是创建一个 RefImpl 对象，然后代理了其中 value 属性的 getter 和 setter<br>Object.seal 让一个对象密封，并返回被密封后的对象。密封对象是指那些不能添加新的属性，不能删除已有属性，以及不能修改已有属性的可枚举性、可配置性、可写性，但可以修改已有属性的值的对象。</p>
<h3 id="toRef-amp-amp-toRefs"><a href="#toRef-amp-amp-toRefs" class="headerlink" title="toRef &amp;&amp; toRefs"></a>toRef &amp;&amp; toRefs</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRef</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>, <span class="title">K</span> <span class="title">extends</span> <span class="title">keyof</span> <span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="built_in">object</span>: T,</span></span></span><br><span class="line"><span class="params"><span class="function">  key: K</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Ref</span>&lt;<span class="title">T</span>[<span class="title">K</span>]&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="built_in">object</span>[key];</span><br><span class="line">  <span class="keyword">if</span> (isRef&lt;T[K]&gt;(v)) <span class="keyword">return</span> v;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createRef(&#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="built_in">object</span>[key],</span><br><span class="line">    <span class="attr">set</span>: <span class="function">(<span class="params">v</span>) =&gt;</span> (<span class="built_in">object</span>[key] = v),</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRefs</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">Data</span> = <span class="title">Data</span>&gt;(<span class="params">obj: T</span>): <span class="title">ToRefs</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isPlainObject(obj)) <span class="keyword">return</span> obj <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ret: <span class="built_in">any</span> = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    ret[key] = toRef(obj, key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把对象的某个属性变成 Ref 类型<br>如果已经是 Ref 类型了，直接返回，否则返回通过 createRef 创建的对象<br>需要注意传入的 object 必须是一个响应式对象，否则返回的 Ref 是不具有响应式特性的，因为无法进行依赖收集相关的操作。</p>
<h3 id="unref"><a href="#unref" class="headerlink" title="unref"></a>unref</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unref</span>&lt;<span class="title">T</span>&gt;(<span class="params">ref: T</span>): <span class="title">T</span> <span class="title">extends</span> <span class="title">Ref</span>&lt;<span class="title">infer</span> <span class="title">V</span>&gt; ? <span class="title">V</span> : <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isRef(ref) ? (ref.value <span class="keyword">as</span> <span class="built_in">any</span>) : ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回 Ref 的 value 属性</p>
<h3 id="shallowRef"><a href="#shallowRef" class="headerlink" title="shallowRef"></a>shallowRef</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shallowRef</span>(<span class="params">raw?: unknown</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isRef(raw)) &#123;</span><br><span class="line">    <span class="keyword">return</span> raw;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> value = shallowReactive(&#123; [RefKey]: raw &#125;);</span><br><span class="line">  <span class="keyword">return</span> createRef(&#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> value[RefKey] <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">    <span class="attr">set</span>: <span class="function">(<span class="params">v</span>) =&gt;</span> ((value[RefKey] <span class="keyword">as</span> <span class="built_in">any</span>) = v),</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很好理解，这里的 reactive 对象是通过 shallowReactive 创建的</p>
<h3 id="customRef"><a href="#customRef" class="headerlink" title="customRef"></a>customRef</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">customRef</span>&lt;<span class="title">T</span>&gt;(<span class="params">factory: CustomRefFactory&lt;T&gt;</span>): <span class="title">Ref</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> version = ref(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> createRef(</span><br><span class="line">    factory(</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="built_in">void</span> version.value,</span><br><span class="line">      <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        ++version.value;</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>允许传入一个工厂方法，属于比较高级的应用，略过</p>
<h3 id="triggerRef"><a href="#triggerRef" class="headerlink" title="triggerRef"></a>triggerRef</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">triggerRef</span>(<span class="params">value: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isRef(value)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  value.value = value.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>vue3 文档上的例子，手动触发响应式侦测</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shallow = shallowRef(&#123;</span><br><span class="line">  <span class="attr">greet</span>: <span class="string">&quot;Hello, world&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Logs &quot;Hello, world&quot; once for the first run-through</span></span><br><span class="line">watchEffect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(shallow.value.greet);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This won&#x27;t trigger the effect because the ref is shallow</span></span><br><span class="line">shallow.value.greet = <span class="string">&quot;Hello, universe&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Logs &quot;Hello, universe&quot;</span></span><br><span class="line">triggerRef(shallow);</span><br></pre></td></tr></table></figure>
<h3 id="proxyRefs"><a href="#proxyRefs" class="headerlink" title="proxyRefs"></a>proxyRefs</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/composition-api/src/reactivity/ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">proxyRefs</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  objectWithRefs: T</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">ShallowUnwrapRef</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isReactive(objectWithRefs)) &#123;</span><br><span class="line">    <span class="keyword">return</span> objectWithRefs <span class="keyword">as</span> ShallowUnwrapRef&lt;T&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> value: Record&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; = reactive(&#123; [RefKey]: objectWithRefs &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> <span class="built_in">Object</span>.keys(objectWithRefs)) &#123;</span><br><span class="line">    proxy(value, key, &#123;</span><br><span class="line">      <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isRef(value[key])) &#123;</span><br><span class="line">          <span class="keyword">return</span> value[key].value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value[key];</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">set</span>(<span class="params">v: unknown</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isRef(value[key])) &#123;</span><br><span class="line">          <span class="keyword">return</span> (value[key].value = unref(v));</span><br><span class="line">        &#125;</span><br><span class="line">        value[key] = unref(v);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> value <span class="keyword">as</span> ShallowUnwrapRef&lt;T&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看了一下，是 vue3 的新特性方法，这里也跟进了<br>如果 objectWithRefs 的属性是 Ref 的话，自动进行拆装箱</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">jiezi19971225</p>
  <div class="site-description" itemprop="description">记录编程学习路上的点滴</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jiezi19971225</span>
</div>
  <img src="https://static.dy208.cn/o_1dfilp8ruo521thr1hvf18ji17soa.png"/>
  <a href="http://www.beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">皖ICP备17001385号-1</a>
  <br/>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
